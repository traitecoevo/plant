---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE}
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(deSolve)
```

```{r}
devtools::load_all(".")

library(plant)
```


```{r warning=FALSE}
source("R/solar_model.R")
source("water_bucket_submodel/R/reference_soil.R")
source("water_bucket_submodel/R/reference_leaf.R")
```

```{r}
calc_temp <- function(instant_of_day, day_length, mean_temp, temp_diff, sun_rise, sun_down){

# Parton and Logan (1981) A model for dirunal variation in soil and
#        air temperature. Agricultural Meteorology, 23, 205--216.

# get_chunk_and_distribute_subdaily

a_t = 1.86;
b_t = 2.2;     #nighttime coeffcient
c_t = -0.17;   #lag of the min temp from the time of runrise

min_temp = mean_temp - temp_diff/2
max_temp = mean_temp + temp_diff/2

sun_rise = sun_rise
sun_down = sun_down

m = instant_of_day - sun_rise + c_t

if(instant_of_day >= sun_rise & instant_of_day <= sun_down){
  min_temp + (max_temp - min_temp) * sin((pi * m) / (day_length + 2.0 * a_t))
} else {
    NA
  }
}

```

```{r}
params <- expand_grid(day = runif(10, min = 0, 180), latitude = runif(10, min = 0, max = 60), temp_diff = runif(1, min = 5, max = 20), VP = runif(1, 0.5, 2), mean_temp = 20, vcmax = runif(1, 30, 100), psi_soil = runif(1, 0, 10), p_50 = runif(1, min = 1, max = 10)) %>%
  slice(sample(1:nrow(.))) %>%
  slice(1:100) 
```


```{r}
expand_input_data <- function(...){    
  params = tibble(...)  

  params %>%
  mutate(sun_rise = sun_rise(day, latitude),
         sun_down = sun_rise + (12-sun_rise)*2,
         day_length = sun_down - sun_rise,
         day_floor = floor(day),
         day_length_dec = day_length/24) %>%
  expand_grid(instant_through_day_hr = seq(sun_rise, sun_down, length.out = 201)) %>%
  mutate(instant_through_day_dec = instant_through_day_hr/24,
         dec_day_time = day_floor+ instant_through_day_dec) %>% 
  mutate(solar_angle = solar_angle(dec_day_time, latitude),
         PAR = PAR_given_solar_angle(solar_angle)) %>%
  rowwise() %>%
  mutate(temp = calc_temp(instant_through_day_hr, day_length, mean_temp, temp_diff, sun_rise, sun_down)) %>%
  mutate(VPD_hr = max(0.001, calc_vpsat(temp) - VP))
  }

```

```{r}
find_profit <- function(...){

params <- tibble(...)
  
vcmax = params$vcmax #maximum carboxylation rate, defined by leaf nitrogen (umol m^-2 s^-1) 
p_50 = params$p_50 #stem water potential at 50% loss of conductivity
b = 2.072101 #shape parameter for vulnerability curve, point of 37% conductance (-MPa) 
c = 2.04 #shape parameter for hydraulic vulnerability curve (unitless) estimated from trait data in Austraits from Choat et al. 2012
psi_crit = calc_psi_crit(b, c) #stem water potential at which conductance is 95%
huber_value = 0.000157 #huber value (m^2 sapwood area m^-2 leaf area)
K_s = 2 #stem-specific conductivity (kg h2o m^-1 stem s^-1 MPa^-1)
h = 5 #height or path length (m)
k_l_max = calc_k_l_max(K_s, huber_value, h)
l <- Leaf(vcmax = vcmax, p_50 = p_50, c = c, b = b, psi_crit = psi_crit, beta=15000, beta_2 = 1, huber_value = huber_value, K_s = K_s, epsilon_leaf = 0.0001)
l$set_physiology(PPFD = params$PAR, psi_soil = params$psi_soil, k_l_max = k_l_max, atm_vpd = params$VPD_hr)
l$optimise_ci_Sperry_Newton_recall_one_line(NA)
l$profit
}
```


```{r}
calc_profit_instant <- function(...){
  params <- tibble(...) %>%
  mutate(profit = pmap(., find_profit) %>%
  unlist())
}
```

```{r}
calc_one_point <- function(data){
   data %>%
    filter(abs(instant_through_day_dec - 0.5) == min(abs(instant_through_day_dec - 0.5))) %>%
    mutate(daily_profit = profit*day_length) -> out
  
  return(out$daily_profit)
}
```


```{r}
future::plan("multisession", workers = 8)
```


```{r}
exanded_input_data <- params %>%
  pmap(expand_input_data) %>%
  bind_rows() %>%
  filter(PAR > 1e-10) %>% 
  future_pmap(calc_profit_instant) %>%
  bind_rows() %>%
  nest(outputs = c(instant_through_day_hr, instant_through_day_dec, dec_day_time, solar_angle, PAR, temp, VPD_hr, profit, day_length))
```

```{r}
exanded_input_data %>%
  mutate(integrated_daily_profit = map_dbl(outputs, ~plant:::trapezium(.x$instant_through_day_hr, .x$profit)),
         one_point_daily_profit = map_dbl(outputs, calc_one_point))
```



```{r}
example_params <- params %>%
  slice(6)

example_params <- calc_input_data(example_params)
example_params %>%
  ungroup() %>%
  slice(201) ->example_params

vcmax = example_params$vcmax #maximum carboxylation rate, defined by leaf nitrogen (umol m^-2 s^-1) 
p_50 = example_params$p_50 #stem water potential at 50% loss of conductivity
c = 2.04 #shape parameter for hydraulic vulnerability curve (unitless) estimated from trait data in Austraits from Choat et al. 2012
b = calc_vul_b(p_50, c) #shape parameter for vulnerability curve, point of 37% conductance (-MPa) 
psi_crit = calc_psi_crit(b, c) #stem water potential at which conductance is 95%
huber_value = 0.000157 #huber value (m^2 sapwood area m^-2 leaf area)
K_s = 2 #stem-specific conductivity (kg h2o m^-1 stem s^-1 MPa^-1)
h = 5 #height or path length (m)
k_l_max = calc_k_l_max(K_s, huber_value, h)
l <- Leaf(vcmax = vcmax, p_50 = p_50, c = c, b = b, psi_crit = psi_crit, beta=15000, beta_2 = 1, huber_value = huber_value, K_s = K_s, epsilon_leaf = 0.0001)
l$set_physiology(PPFD = example_params$PAR, psi_soil = example_params$psi_soil, k_l_max = k_l_max, atm_vpd = example_params$VPD_hr)
l$calc_j()
l$calc_g_c(psi_crit)
l$optimise_ci_Sperry_Newton_recall_one_line(NA)
```

```{r}
l <- Leaf(vcmax = vcmax, p_50 = p_50, c = c, b = b, psi_crit = psi_crit, beta=15000, beta_2 = 1, huber_value = huber_value, K_s = K_s, epsilon_leaf = 0.0001)
l$set_physiology(PPFD = example_params$PAR*1e17, psi_soil = example_params$psi_soil, k_l_max = k_l_max, atm_vpd = example_params$VPD_hr)
l$calc_j() == 0
l$calc_A_lim(38) == 0
l$find_max_ci_one_line() - 40
l$calc_A_lim_one_line(l$find_max_ci_one_line())
l$calc_profit_Sperry_ci_one_line(exp(log(l$find_max_ci_one_line())))


tibble(ci = seq(gamma_25 *umol_per_mol_2_Pa, l$find_max_ci_one_line(), length.out= 100000)) %>%
  rowwise() %>%
  mutate(profit = l$calc_profit_Sperry_ci_one_line(ci)) %>%
  ggplot(aes(x=ci, y= profit)) +
  geom_line() +
  xlim(c(39.999,40))
```


```{r}
diff_value = 0.001; 
  
  opt_ci = NA;

  if (R_IsNA(opt_ci)){
  
  opt_ci = l$find_max_ci_one_line() - diff_value;

  }

  while(unfinished == 1){

    if(count > 2){
      
      double max_ci = find_max_ci_one_line();
      optimise_ci_Sperry_one_line(max_ci);

      return;

    }

    ci_initial = opt_ci;

    if (!util::is_finite(opt_ci)) {
      util::stop("Detected NAN ci value");
    }

    x_1 = ci_initial - diff_value;
    x_2 = ci_initial + diff_value;

    benefit_ = l$calc_A_lim_one_line(ci_initial);

    g_c_ci = (benefit_ * 1e-6 * 101.3 * 1000)/(40 - x_2); 
    
    E = g_c_ci * 1.6 * 2 / 55.4939 / 101.3;  

    E_max = l$calc_E_supply(psi_crit);

    if(((E_max < E) & (abs(E - E_max) > 1e-15)) | (E < 0)){
    opt_ci = l$find_max_ci_one_line() - diff_value;
    continue;
    } else{
    psi_stem = l$calc_psi_stem_ci(E);
    cost_ = l$calc_hydraulic_cost_Sperry(psi_stem);
    y_2 = benefit_ - l$lambda_*cost_;
    }
    y_1 = l$calc_profit_Sperry_ci_one_line(x_1);

    y_0 = l$calc_profit_Sperry_ci_one_line(ci_initial);

    first_dev = (y_2 - y_1)/(2*diff_value);
    sec_dev = (y_2 - 2*y_0 + y_1)/diff_value^2;

    opt_ci = ci_initial -  first_dev/sec_dev;

    if(abs(opt_ci - ci_initial) < (ci_initial*epsilon_leaf)){
      unfinished = 0;
    }

    profit = y_0;
  }

    return;
  }
```


```{r}
calc_daily_model <- function(params){
  params %>%
  mutate(daily_data = map2(latitude, day, ~calc_PPFD_instant(.x, .y))) %>%
  select(-c(latitude, day)) %>%
  unnest(daily_data) %>%
  rowwise() %>%
  mutate(VPH = calc_VPH(instant_of_day, VPD_9, VPD_15), 
         temp = calc_temp(instant_of_day, sun_up, sun_down, day_length, min_temp = air_temp_c-diff_temp, max_temp = air_temp_c + diff_temp)) %>%
    mutate(VPD_hourly = max(0.001,calc_vpsat(temp) - VPH)) %>%
    mutate(profit = find_opt_psi_stem(psi_soil = psi_soil, k_l_max = k_l_max, vcmax = vcmax, PPFD = PPFD_umol_m2_s_instant, b = b, c = c, psi_crit = psi_crit, atm_vpd = VPD_hourly, ca = ca)$profit_root)
}
```


```{r}
calc_one_point <- function(data){
  data %>%
    mutate(midday = (sun_down - sun_up)/2 + sun_up) %>%
    filter(abs(instant_of_day - midday) == min(abs(instant_of_day - midday))) %>%
    pull(profit) -> day_profit
  
  data %>%
    slice(1) %>%
    pull(profit)  -> night_profit
  day_night_profit <- c(day_profit, night_profit)
  
  data %>%
    slice(1) %>%
    summarise(day_length = day_length, night_length = 1 - day_length) -> day_night_length
  # sum(day_night_length*day_night_profit)
  return(sum(day_night_length*day_night_profit))
  }
```

```{r}
calc_three_point <- function(data){
  data %>%
  ungroup() %>%
  mutate(midday = (sun_down - sun_up)/2 + sun_up) %>%
  slice(which.min(abs(instant_of_day - midday))) -> day_profit

data %>%
  ungroup() %>%
  mutate(after_sunrise = sun_up + 1/24) %>%
  slice(which.min(abs(instant_of_day - after_sunrise))) -> sunrise_profit

data %>%
  ungroup() %>%
  mutate(before_sunset = sun_down - 1/24) %>%
  slice(which.min(abs(instant_of_day - before_sunset))) -> sunset_profit

x <- c(sunrise_profit$sun_up, sunrise_profit$instant_of_day, day_profit$instant_of_day, sunset_profit$instant_of_day, sunset_profit$sun_down)

y <- c(0, sunrise_profit$profit, day_profit$profit, sunset_profit$profit, 0)

outputs %>%
  ungroup() %>%
    slice(1) %>%
  mutate(night_length = 1- day_length, night_profit = night_length*profit) %>%
  pull(night_profit) -> night_profit


plant:::trapezium(x,y) + night_profit 

  }
```

```{r}
length_required <- 4

params <- set_params_soil(day = round(seq(1, 180, length.out = length_required)), latitude = seq(0, 60, length.out = length_required), vcmax = seq(30, 100, length.out = length_required), diff_temp = seq(5,10,length.out = length_required), VPD_9 = seq(0.5,2, length.out = length_required), diff_VH = seq(0.5,2, length.out = length_required), p50 = seq(1,5, length.out = length_required))

outputs <- calc_daily_model(params)
```

```{r}
outputs %>%
      ungroup() %>%
      nest(daily_data = c(profit, instant_of_day, PPFD_umol_m2_s_instant, VPD_hourly, sun_up, sun_down, day_length, VPH, temp)) %>%
      mutate(true_daily_profit = map_dbl(daily_data, ~plant:::trapezium(.x$instant_of_day, .x$profit)),
             one_point_estimate = map_dbl(daily_data, calc_one_point),
             three_point_estimate = map_dbl(daily_data, calc_three_point)) -> outputs_integrated
```

```{r}
outputs_integrated %>%
  ggplot() +
  geom_point(aes(x = true_daily_profit, y = three_point_estimate)) +
  geom_point(aes(x = true_daily_profit, y = one_point_estimate), col = "red") +
  geom_abline(slope=1, intercept =0.3)
```


```{r}
outputs_integrated %>%
  filter(true_daily_profit < 0) %>%
  View()
```


```{r}
ggplot() +
  geom_line(data = outputs, aes(x = instant_of_day, y = profit)) +
  geom_line(aes(x = x, y = y))
```



```{r}
ggplot(daily_data) +
  geom_line(aes(x=instant_of_day, y=profit))


calc_daily_model <- function(params){
  soil_params %>%
  mutate(daily_data = map2(latitude, day, ~calc_PPFD_instant(.x, .y))) %>%
  select(-c(latitude, day)) %>%
  unnest(daily_data) %>%
  rowwise() %>%
  mutate(profit = find_opt_psi_stem_bartlett(psi_soil = psi_soil, k_l_max = k_l_max, vcmax = vcmax, PPFD = PPFD_umol_m2_s_instant, b = b, c = c, psi_crit = psi_crit, atm_vpd = VPD_hourly, ca = ca, beta = beta1, beta_2 = beta2, huber_value = h_v, height = h)$profit_root)
}

```







```{r}

calc_VPD_daily <- function(sun_up, sun_down, VPD_9, VPD_15, instant_of_day) {
  
  VPD_data <- tibble(time = c(0,unique(sun_up),unique(sun_down),1), VPD = c(1, unique(VPD_9), unique(VPD_15), 1))

  VPD_data %>%
  spline(x = .$time, y = .$VPD, xout = instant_of_day, method = "natural") %>%
    as_tibble() %>%
    pull(y)
  
}
```


```{r}
calc_true_daily <- function(data){

slice(data, 1) %>%
  pull(profit) -> night_profits
  
night_frac <- 1 - slice(data, 1) %>%
  pull(day_length)


data %>% 
  filter(sun_up <= instant_of_day & instant_of_day <= sun_down) %>%
  summarise(profit = plant:::trapezium(x = .$instant_of_day, y = .$profit)) %>%
  pull(profit) -> profit

profit + night_profits*night_frac

}
```



```{r}

calc_defined_points <- function(data, defined_sects){
  
slice(data, 1) %>%
  pull(profit) -> night_profits


map(defined_sects, ~which.min(abs(data %>% pull(instant_of_day) - .x))) %>% unlist() %>% slice(data, .) -> day_profits

diff(c(day_profits$sun_up[1],day_profits$instant_of_day,day_profits$sun_down[1])) -> day_segments


     
  #    
  #    (unique(sun_down)-unique(sun_up))*defined_sects + unique(sun_up)) %>%
  # map(~which.min(abs(data %>% pull(instant_of_day) - .x))) %>%
  # unlist() %>%
  # slice(data, .) -> time_outputs

}
```

```{r}
outputs %>%
      ungroup() %>%
      nest(daily_data = c(profit, instant_of_day, PPFD_umol_m2_s_instant, VPD_hourly, sun_up, sun_down, day_length)) %>%
      mutate(true_daily_profit = map(daily_data, calc_defined_points, c(9/24,12/24,15/24))) %>%
  View()
```














```{r}

calc_mult_points <- function(data, num_sects){


slice(data, 1) %>%
  pull(profit) -> night_profits
  
unique(data %>% pull(day_length)/(num_sects-1))->day_frac

with(data, seq(from = unique(sun_up), to = unique(sun_down), by = day_frac)) %>%
    map(~which.min(abs(data %>% pull(instant_of_day) - .x))) %>%
    unlist() %>%
    slice(data, .) -> time_outputs

  with(data, seq(from = unique(sun_up) - 0.5*day_frac, to = unique(sun_down) - 0.5*day_frac, by = day_frac)) %>%
    map(~which.min(abs(data %>%
                         pull(instant_of_day) - .x))) %>%
    unlist() %>%
    slice(data, .) -> profit_outputs


   times <- c(time_outputs$instant_of_day[1] - time_outputs$sun_up[1], diff(time_outputs$instant_of_day))
  profits <- profit_outputs$profit
  
  day_profit <- sum(times*profits)


  total_profit <- sum(times*profits) + night_profits*(1-unique(data$day_length))
  
  # tibble(day_profit = rep(day_profit, num_sects*2), total_profit = rep(total_profit, num_sects*2), x_coords = rep(time_outputs$instant_of_day, each = 2), y_coords = c(0, rep(profit_outputs$profit[-1], each = 2), 0))

  total_profit
  
}
```


```{r}
nseq = 5

soil_params <- set_params_soil(day = seq(1,180,length.out = nseq), evap_routine = "1")
```




```{r}
outputs <- calc_daily_model(soil_params)

saveRDS(outputs, "outputs.RDS")
```


```{r}
num_sects <- seq(2,4)

map(num_sects, ~outputs %>%
      ungroup() %>%
      nest(daily_data = c(profit, instant_of_day, PPFD_umol_m2_s_instant, VPD_hourly, sun_up, sun_down, day_length)) %>%
      mutate(true_daily_profit = map_dbl(daily_data, ~plant:::trapezium(.x$instant_of_day, .x$profit))) %>%
      mutate(estimated_daily_profit_mult = map(daily_data, calc_mult_points, .x)) %>%
      mutate(num_sects = .x)
) %>%
  bind_rows()%>%
  group_by(num_sects) %>%
  mutate(rmsd = sqrt(sum((true_daily_profit - unlist(estimated_daily_profit_mult))^2)/length(true_daily_profit))) -> outputs_integrated
```


```{r}
outputs_integrated %>%
  ggplot(aes(x = true_daily_profit , y = unlist(estimated_daily_profit_mult))) +
  geom_point(aes(col = num_sects)) +
  geom_abline(slope = 1, intercept = 0.15)

```

```{r}
outputs %>%
  group_by(day) %>%
  filter(profit == max(profit)) -> outputs_summarised

outputs_summarised$instant_of_day
outputs_summarised$sun_up
outputs_summarised$sun_down
outputs_summarised$day_length

(outputs_summarised$instant_of_day - outputs_summarised$sun_up) / outputs_summarised$day_length
```


















```{r}
num_sects <- seq(2,100)

map(num_sects, ~outputs %>%
      ungroup() %>%
      nest(daily_data = c(profit, instant_of_day, PPFD_umol_m2_s_instant, VPD_hourly, sun_up, sun_down, day_length)) %>%
      mutate(true_daily_profit = map_dbl(daily_data, ~plant:::trapezium(.x$instant_of_day, .x$profit))) %>%
      mutate(estimated_daily_profit_mult = map(daily_data, calc_mult_points, .x)) %>%
      mutate(num_sects = .x)
) %>%
  bind_rows() -> outputs_integrated

outputs_integrated %>%
  group_by(num_sects) %>%
  summarise(rmsd = sum((true_daily_profit - unlist(estimated_daily_profit_mult))^2)/length(true_daily_profit)) %>%
  ggplot(aes(x = rmsd, y = num_sects)) +
  geom_path()


%>%
  nest(profits = c(true_daily_profit, estimated_daily_profit_mult, day, num_sects)) %>%
  mutate(rmsd = map_dbl(profits, ~sqrt(sum((.x$true_daily_profit - unlist(.x$estimated_daily_profit_mult))^2)/length(.x$true_daily_profit))))-> outputs_integrated
```

```{r}
outputs_integrated %>%
  ggplot() +
  geom_point(aes(x = true_daily_profit, y = unlist(estimated_daily_profit_mult), col = day)) +
  geom_line(aes(x = true_daily_profit, y = unlist(estimated_daily_profit_mult), group = num_sects, linetype = as.factor(num_sects))) +
  geom_abline(intercept = 0, slope = 1)





outputs_integrated %>% 
  slice(1) %>%
  unnest(estimated_daily_profit_mult) %>% 
  unnest(daily_data) %>%
  ggplot(aes(x=instant_of_day, y= profit)) +
  geom_polygon(aes(x = x_coords,  y= y_coords), alpha = 0.5, fill = "black") +
  geom_line(colour = "red", size = 2) 
```


```{r}
outputs_integrated %>%
  pivot_longer(contains("estimated")) %>%
  ggplot(aes(x = true_daily_profit, y = value, col = name)) + 
  geom_point()

cor(outputs_integrated$true_daily_profit, outputs_integrated$estimated_daily_profit_1)
cor(outputs_integrated$true_daily_profit, outputs_integrated$estimated_daily_profit_3)

outputs_integrated %>%
  ggplot(aes(x = true_daily_profit, y = estimated_daily_profit, col = as.factor(day))) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0)

outputs_integrated$daily_data[[1]] %>%
  slice(101)

outputs %>%
  filter(day == 1) %>%
  ggplot() +
  geom_polygon(data = outputs_integrated$daily_data[[1]][101,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=value[c(1,3,2,4)], y = c(0,profit[2],profit[4],0)), fill = "black") +
  geom_polygon(data = outputs_integrated$daily_data[[1]][1,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=c(0,0,value[1],value[1]), y = c(profit[1],0,0,profit[1])), fill = "black") +
  geom_polygon(data = outputs_integrated$daily_data[[1]][1,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=c(value[2],value[2],1,1), y = c(profit[1],0,0,profit[1])), fill = "black") +
  geom_line(aes(x = instant_of_day, y = profit))


outputs %>%
  filter(day == 1) %>%
  pull(profit)[1] -> night_profits
  
  unique(data$day_length/(num_sects-1))->day_frac
  
  
  with(data, seq(from = unique(sun_up), to = unique(sun_down), by = day_frac))[2:num_sects] %>%
    map(~which.min(abs(data$instant_of_day - .x))) %>%
    unlist() %>%
    slice(data, .) -> time_outputs
  
  
  with(data, seq(from = unique(sun_up) - 0.5*day_frac, to = unique(sun_down) - 0.5*day_frac, by = day_frac))[2:num_sects] %>%
    map(~which.min(abs(data$instant_of_day - .x))) %>%
    unlist() %>%
    slice(data, .) -> profit_outputs
  
  
  times <- c(time_outputs$instant_of_day[1] - time_outputs$sun_up[1], diff(time_outputs$instant_of_day))
  profits <- profit_outputs$profit
  
  day_profit <- sum(times*profits)
  night_profit <- night_profits * (1-unique(data$day_length))
  
  day_profit+night_profit  
  
  
  
  ggplot() +
  geom_polygon(data = outputs_integrated$daily_data[[1]][101,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=value[c(1,3,2,4)], y = c(0,profit[2],profit[4],0)), fill = "black") +
  geom_polygon(data = outputs_integrated$daily_data[[1]][1,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=c(0,0,value[1],value[1]), y = c(profit[1],0,0,profit[1])), fill = "black") +
  geom_polygon(data = outputs_integrated$daily_data[[1]][1,] %>% slice(rep(1:n(), each = 2))  %>% pivot_longer(contains("sun")),aes(x=c(value[2],value[2],1,1), y = c(profit[1],0,0,profit[1])), fill = "black") +
  geom_line(aes(x = instant_of_day, y = profit))



```


