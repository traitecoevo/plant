---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r warning=FALSE}
rm(list=ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(deSolve)
library(lhs)
```

```{r}
devtools::load_all(".")
library(plant)
library(furrr)
```


```{r warning=FALSE}
source("R/solar_model.R")
source("water_bucket_submodel/R/reference_soil.R")
source("water_bucket_submodel/R/reference_leaf.R")
```

```{r}
calc_temp <- function(instant_of_day, day_length, mean_temp, temp_diff, sun_rise, sun_down){

# Parton and Logan (1981) A model for dirunal variation in soil and
#        air temperature. Agricultural Meteorology, 23, 205--216.

# get_chunk_and_distribute_subdaily

a_t = 1.86;
b_t = 2.2;     #nighttime coeffcient
c_t = -0.17;   #lag of the min temp from the time of runrise

min_temp = mean_temp - temp_diff/2
max_temp = mean_temp + temp_diff/2

sun_rise = sun_rise
sun_down = sun_down

m = instant_of_day - sun_rise + c_t

if(instant_of_day >= sun_rise & instant_of_day <= sun_down){
  min_temp + (max_temp - min_temp) * sin((pi * m) / (day_length + 2.0 * a_t))
} else {
    NA
  }
}

```

```{r}

LHS <- randomLHS(10000, 10)

params <- tibble(mean_temp = 20, temp_diff = qunif(LHS[,1], min = 5, max = 20), latitude = qunif(LHS[,2], min = 0, max = 60), VP = qunif(LHS[,3], 0.5, 2),
                   vcmax = qunif(LHS[,4], 30, 100), p_50 = qunif(LHS[,5], min = 1, max = 10), huber_value = qunif(LHS[,6], min = 0.000157/2, max =  0.000157*2),
                   day = qunif(LHS[,7], min = 0, 180), h = qunif(LHS[,8], min = 5, max = 80), E = qunif(LHS[,9], min = 0, max = 1), psi_soil = qunif(LHS[,10], 0, 10))

# sites_params <- expand_grid(mean_temp = 20, temp_diff = runif(10, min = 5, max = 20), latitude = runif(10, min = 0, max = 60), VP = runif(10, 0.5, 2)) %>%
#   sample_n(16)
# 
# between_spp_params <- expand_grid(vcmax = runif(10, 30, 100), p_50 = runif(10, min = 1, max = 10), huber_value = runif(10, min = 0.000157/2, max =  0.000157*2)) %>%
#   sample_n(16)
# 
# within_spp_params <- expand_grid(day = runif(10, min = 0, 180), h = runif(10, min = 5, max = 80), E = runif(10, min = 0, max = 1), psi_soil = runif(10, 0, 10)) %>%
#   sample_n(16)
# 
# sites_params %>%
#   expand_grid(between_spp_params) %>%
#   expand_grid(within_spp_params) -> params
```


```{r}
expand_input_data <- function(...){    
  params = tibble(...)  

  params %>%
  mutate(sun_rise = sun_rise(day, latitude),
         sun_down = sun_rise + (12-sun_rise)*2,
         day_length = sun_down - sun_rise,
         day_floor = floor(day),
         day_length_dec = day_length/24) %>%
  expand_grid(instant_through_day_hr = seq(sun_rise, sun_down, length.out = 100)) %>%
  mutate(instant_through_day_dec = instant_through_day_hr/24,
         dec_day_time = day_floor+ instant_through_day_dec) %>% 
  mutate(solar_angle = solar_angle(dec_day_time, latitude),
         PAR = PAR_given_solar_angle(solar_angle)) %>%
  rowwise() %>%
  mutate(temp = calc_temp(instant_through_day_hr, day_length, mean_temp, temp_diff, sun_rise, sun_down)) %>%
  mutate(VPD_hr = max(0.001, calc_vpsat(temp) - VP))
  }

```

```{r}
find_profit <- function(...){
require(plant)
params <- tibble(...)


p_50_2_K_s <- function(p50){
  1.638999*(p50/2)^(-1.38)
}

calc_vul_b <- function(p_50, c){
  num <- p_50
  den <- (-log(1-50/100))^(1/c)
  num/den
}


calc_psi_crit <- function(b,c) {
  b*(log(1/0.05))^(1/c)
}



vcmax = params$vcmax #maximum carboxylation rate, defined by leaf nitrogen (umol m^-2 s^-1) 
p_50 = params$p_50 #stem water potential at 50% loss of conductivity
c = 2.04 #shape parameter for hydraulic vulnerability curve (unitless) estimated from trait data in Austraits from Choat et al. 2012
b = calc_vul_b(p_50, c) #shape parameter for vulnerability curve, point of 37% conductance (-MPa) 
psi_crit = calc_psi_crit(b, c) #stem water potential at which conductance is 95%
huber_value = params$huber_value #huber value (m^2 sapwood area m^-2 leaf area)
K_s = p_50_2_K_s(p_50) #stem-specific conductivity (kg h2o m^-1 stem s^-1 MPa^-1)
h = params$h #height or path length (m)
k_l_max = calc_k_l_max(K_s, huber_value, h)
l <- plant:::Leaf(vcmax = vcmax, p_50 = p_50, c = c, b = b, psi_crit = psi_crit, beta=15000, beta_2 = 1, huber_value = huber_value, K_s = K_s, epsilon_leaf = 0.0001)
l$set_physiology(PPFD = params$PAR*params$E, psi_soil = params$psi_soil, k_l_max = k_l_max, atm_vpd = params$VPD_hr)
l$optimise_ci_Sperry_Newton_recall_one_line(NA)
l$profit
}
```


```{r}
calc_profit_instant <- function(...){
  require(plant)
  params <- tibble(...) %>%
  mutate(profit = pmap(., find_profit) %>%
  unlist())
}
```

```{r}
calc_one_point <- function(data){
(12 - min(data$instant_through_day_hr)) * 2 -> day_length_hr
  data %>%
    filter(abs(instant_through_day_dec - 0.5) == min(abs(instant_through_day_dec - 0.5))) %>%
    mutate(daily_profit = profit*(day_length_hr)) %>%
    sample_n(1) -> out
  
  out$daily_profit
  
}
```


```{r}
future::plan("multisession", workers = 8)
```


```{r}
exanded_input_data2 <- params %>%
  future_pmap(expand_input_data) %>%
  bind_rows() %>%
  filter(PAR > 1e-10) %>% 
  future_pmap(calc_profit_instant) %>%
  bind_rows() %>%
  nest(outputs = c(instant_through_day_hr, instant_through_day_dec, dec_day_time, solar_angle, PAR, temp, VPD_hr, profit))
```

```{r}
exanded_input_data2 %>%
  mutate(integrated_daily_profit = map_dbl(outputs, ~plant:::trapezium(.x$instant_through_day_hr, .x$profit))) %>%
  mutate(one_point_profit = map_dbl(outputs, calc_one_point)) -> expanded_output

expanded_output %>% 
  ggplot(aes(x =integrated_daily_profit,  y= one_point_profit)) +
  geom_hex() +
  geom_abline(slope = 1, intercept =0) +
  theme_classic()
```


```{r}
expanded_output %>% 
  ggplot(aes(x =integrated_daily_profit,  y= one_point_profit)) +
  geom_point() +
  geom_abline(slope = 1, intercept =0) +
  theme_classic() +
  xlab("Integrated daily profit") +
  ylab("One-point esimate daily profit") +
  geom_text(data = expanded_output %>%
               filter(abs(integrated_daily_profit - 19.67398) == min(abs(integrated_daily_profit - 19.67398)) |
                        abs(integrated_daily_profit - 31.98577) == min(abs(integrated_daily_profit - 31.98577)) | 
                        abs(integrated_daily_profit - 66.0072) == min(abs(integrated_daily_profit - 66.0072))),
             aes(x = integrated_daily_profit, y = one_point_profit, label = c("D", "B", "C")), nudge_y = c(-2, -2, -2)) +
  geom_point(data = expanded_output %>%
               filter(abs(integrated_daily_profit - 19.67398) == min(abs(integrated_daily_profit - 19.67398)) |
                        abs(integrated_daily_profit - 31.98577) == min(abs(integrated_daily_profit - 31.98577)) | 
                        abs(integrated_daily_profit - 66.0072) == min(abs(integrated_daily_profit - 66.0072))),
             aes(x = integrated_daily_profit, y = one_point_profit), size = 3, shape = 21) +
    geom_point(data = expanded_output %>%
               filter(abs(integrated_daily_profit - 19.67398) == min(abs(integrated_daily_profit - 19.67398)) |
                        abs(integrated_daily_profit - 31.98577) == min(abs(integrated_daily_profit - 31.98577)) | 
                        abs(integrated_daily_profit - 66.0072) == min(abs(integrated_daily_profit - 66.0072))),
             aes(x = integrated_daily_profit, y = one_point_profit), colour = "maroon")-> a

expanded_output %>%
  filter(abs(integrated_daily_profit - 19.67398) == min(abs(integrated_daily_profit - 19.67398))) %>%
  unnest(outputs) %>%
  ggplot(aes(x = instant_through_day_hr, y= profit)) +
  geom_line() +
  geom_polygon(data = . %>%
  filter(abs(instant_through_day_hr - 12) == min(abs(instant_through_day_hr - 12))) %>%
  tibble(x = c(sun_rise, sun_rise, 12, sun_down, sun_down), y = c(0, min(profit), min(profit), min(profit), 0)),
  aes(x = x, y = y), fill = NA, colour = "black", linetype = "dashed") +
  geom_point(data = . %>%
  filter(abs(instant_through_day_hr - 12) == min(abs(instant_through_day_hr - 12))),
  aes(x = instant_through_day_hr, y = profit), colour = "black") +
  xlab("Time (hrs)") +
  ylab(expression(Profit~(umol~mol^{-1}~m^{-2}~s^{-1}))) +
  theme_classic() -> b

expanded_output %>%
    filter(abs(integrated_daily_profit - 31.98577) == min(abs(integrated_daily_profit - 31.98577))) %>%
    unnest(outputs) %>%
  ggplot(aes(x = instant_through_day_hr, y= profit)) +
  geom_line() +
  geom_polygon(data = . %>%
  filter(abs(instant_through_day_hr - 12) == min(abs(instant_through_day_hr - 12))) %>%
  tibble(x = c(sun_rise, sun_rise, 12, sun_down, sun_down), y = c(0, min(profit), min(profit), min(profit), 0)),
  aes(x = x, y = y), fill = NA, colour = "black", linetype = "dashed") +
  geom_point(data = . %>%
  filter(abs(instant_through_day_hr - 12) == min(abs(instant_through_day_hr - 12))),
  aes(x = instant_through_day_hr, y = profit), colour = "black") +
  xlab("Time (hrs)") +
  ylab(expression(Profit~(umol~mol^{-1}~m^{-2}~s^{-1}))) +
  theme_classic()-> c

expanded_output %>%
    filter(abs(integrated_daily_profit - 66.0072) == min(abs(integrated_daily_profit - 66.0072))) %>%
    unnest(outputs) %>%
  ggplot(aes(x = instant_through_day_hr, y= profit)) +
  geom_line() +
  geom_polygon(data = . %>%
  filter(abs(instant_through_day_hr - 12) == min(abs(instant_through_day_hr - 12))) %>%
    sample_n(1) %>%
    tibble(x = c(sun_rise, sun_rise, 12, sun_down, sun_down), y = c(0, min(profit), min(profit), min(profit), 0)),
  aes(x = x, y = y), fill = NA, colour = "black", linetype = "dashed") +
  geom_point(data = . %>%
  filter(abs(instant_through_day_hr - 12) == min(abs(instant_through_day_hr - 12))) %>%
    sample_n(1),
  aes(x = instant_through_day_hr, y = profit), colour = "black") +
  xlab("Time (hrs)") +
  ylab(expression(Profit~(umol~mol^{-1}~m^{-2}~s^{-1}))) +
  theme_classic()-> d
```


```{r}
png("outputs.png", height = 850, width = 850)
cowplot::plot_grid(a,b,c,d, nrow = 2, ncol = 2, labels = "AUTO")
dev.off()
```
