---
title: "leaf_behaviour_diagnostic_tool"
author: "Isaac Towers"
date: "2023-07-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
rm(list=ls())
```

```{r}
devtools::load_all(".")
```

```{r}
library(tidyverse)
```

#example using a tibble of environment values

```{r}
tibble(make_FF16w_parameters(a_f1 = c(0, 0.5))) %>%
  mutate(trait_set = 1:n()) %>%
  group_by(trait_set) %>%
  nest(trait_matrix = c(-trait_set)) %>%
  mutate(trait_matrix = map(trait_matrix, ~expand_parameters(as.matrix(.x), p = FF16w_Parameters()) %>% .$strategy)) %>%
  expand_grid(psi_soil = c(1,2), PPFD = 1000) %>%
  group_by(trait_set) %>%
  mutate(environment_set = 1:n()) %>%
  group_by(trait_set, environment_set) %>%
  nest(environment = -c(trait_set, trait_matrix, environment_set)) %>%
  ungroup() %>%
  mutate(leaf = pmap(.l = list(ff16w_params = trait_matrix, ff16w_env = environment), .f = make_leaf)) -> example_tibble
```

#example setting a ff16env object (to come)

```{r}
```

#use the leaf

```{r}
example_tibble %>%
  expand_grid(ci = seq(5, 40, 5)) %>%
  # need walk here to run optimise because it is a void function (I think)
  mutate(leaf_psi_optimised = walk(.x = leaf, .f = ~.x$optimise_psi_stem_TF)) %>%
  # use the optimised leaf to find optimised values
  mutate(opt_assim = map_dbl(.x = leaf_psi_optimised, .f = ~.x$assim_colimited_)) %>%
  # use a regular leaf to do stuff
  mutate(assim_at_ci = map2_dbl(.x = leaf, .y = ci, ~.x$assim_colimited(.y)))
```

