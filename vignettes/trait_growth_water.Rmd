---
title: "growth_rate_trait_water"
output: html_document
date: "2022-10-24"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
devtools::load_all(".")
```

Define a number of hyper-parameterisations

```{r}
p_50_2_K_s <- function(p50){
  1.638999*(p50/2)^(-1.38)
}

calc_vul_b <- function(p_50, c){
  num <- p_50
  den <- (-log(1-50/100))^(1/c)
  num/den
}


calc_psi_crit <- function(b,c) {
  b*(log(1/0.05))^(1/c)
}

K_s_2_p_50 <- function(K_s){
  1.731347*(K_s/K_s_0)^(-0.7246377)
}

calc_k_l_max <- function(K_s, h_v, h){
  K_s * h_v / h
}
```

```{r}
run_individual <- function(...){
  params <- tibble(...)
  
  p0 <- scm_base_parameters("FF16w")

  # s1 <- strategy(trait_matrix(params$K_s,  "K_s"), p0, birth_rate_list = 1)
  # s1$p_50 <- p_50_2_K_s(s1$K_s)
  # s1$b <- calc_vul_b(s1$p_50, s1$b)
  # s1$psi_crit <- calc_psi_crit(s1$b, s1$c)
  # 
  s1 <- strategy(trait_matrix(params$H_v,  "huber_value"), p0, birth_rate_list = 1)

  indv1 <- FF16w_Individual(s1)
  env <- FF16w_make_environment(soil_initial_state = params$theta)
  env$set_fixed_environment(params$E, 150)
  res <- plant::grow_individual_to_height(indv1, heights = params$height, env, time_max =100)
  }
```


```{r}
expand_grid(H_v = seq(0.000157/2,0.000157*2,length.out = 10), theta=seq(0.01,1,length.out=5), E=c(0.25,0.5,0.75,1), height = c(0.5, 2, 10, 15,20)) %>%
  mutate(results= pmap(., run_individual)) -> output
# 
# expand_grid(K_s = seq(1), theta=seq(0.1), E=c(1), height = c(0.5)) %>%
#   mutate(results= pmap(., run_individual)) -> output

get_dt <- function(y,x) {
  c(NA, diff(y)/diff(x))
}

output %>%
  mutate(run = seq(1:nrow(.))) %>%
  rename(to_height = height) %>%
  mutate(results= map(results, ~pluck(.x, "trajectory") %>% as_tibble())) %>%
  unnest(results) %>%
  group_by(run) %>%
  mutate(height_dt = get_dt(height, time)) %>%
  mutate(max_height = max(height),
         max_time = max(time)) %>%
  nest(states = c(time, height,mortality, fecundity, area_heartwood, mass_heartwood, height_dt)) %>%
  filter(max_height >= to_height) %>%
  mutate(height_dt = map_dbl(states, ~.x %>%
                           tail(1) %>% 
                           pull(height_dt)))-> data_to_plot
```


```{r}
data_to_plot %>%
  ggplot(aes(x= H_v, y = height_dt)) +
  geom_line(aes(group = E, colour = E)) +
  facet_grid(theta~to_height) +
  ylab(expression(paste(Delta~Height," /", Delta~Time, "(m/yr)"))) + 
  xlab(expression(paste(Sapwood~specific~conducitivity~(kg~m^{-1}~s^{-1}~MPa^{-1}))))
```
