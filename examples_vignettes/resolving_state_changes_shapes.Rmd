---
title: "resolving_state_change_shapes"
author: "Isaac Towers"
date: "2022-09-06"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

devtools::load_all(".")
```

```{r}
library(tidyverse)
```

```{r}
library(plant)
```

```{r}
library(furrr)
```

```{r}
results_files <- list.files("examples_vignettes/outputs/resolving_state_changes_shapes")

extract_function <- function(file){
  dir <- "examples_vignettes/outputs/resolving_state_changes_shapes/"
  filename <- file
  path <- paste(dir, filename, sep="")
  
  resultRDS <- readRDS(path)
  results <- tibble(result = list(resultRDS[[1]]$result), parameters = resultRDS[[2]]) %>%
    mutate(error = ifelse(is.null(resultRDS[[1]]$error$message), "NA", resultRDS[[1]]$error$message))
  results
  }

map(results_files, extract_function) %>%
  bind_rows() -> collated_results
```


```{r}
collated_results %>%
  select(-result) %>%
  unnest(parameters) %>%
  mutate(p50_diff = abs(p50_1 - p50_2)) %>%
  ggplot(aes(x = rainfall, y = p50_diff)) +
  geom_text(aes(label = error), size = 3) +
  theme_classic()
```


```{r}
list_or_not  <- rep(NA, nrow(collated_results))
for(i in 1:nrow(collated_results)){
  list_or_not[i] <- is.list(collated_results$result[[i]])
}

collated_results <- collated_results[list_or_not,]  
```

```{r}
extract_tidy <- function(result){
  result %>%
    tidy_patch() %>%
    FF16_expand_state() -> result
  
    result$species %>%
    integrate_over_size_distribution()
}

collated_results %>%
  rowwise() %>%
  mutate(result =list(extract_tidy(result))) -> collated_results2
```


```{r}
set.seed(123)
collated_results2 %>%
  unnest(result) %>%
  unnest(parameters) %>% 
  select(step, time, species, area_leaf, p50_1, p50_2, rainfall) %>% 
  group_by(p50_1, p50_2, rainfall) %>%
  mutate(run = cur_group_id()) %>%
  group_by(step, time, p50_1, p50_2, rainfall) %>%
  mutate(total_leaf = sum(area_leaf), leaf_frac = area_leaf/total_leaf) %>%
  ungroup() %>%
  mutate(species_p50 = if_else(species == 1, p50_1, p50_2)) %>%
  filter(run %in% sample(unique(run),9)) %>%
  group_by(rainfall, run) %>%
  nest() %>%
  ungroup() %>%
  distinct(rainfall, .keep_all = TRUE) %>%
  unnest(data)  -> data_to_plot
  
  data_to_plot %>%
  ggplot(aes(time, area_leaf, group = species_p50, colour = species_p50)) +
  geom_line() +
  facet_wrap(~rainfall, scales = "free")+
  ylab("Leaf area") +
  xlab("Time") +
  labs(colour = "p50")
```

Rainfall of 1.76 lookd pretty jagged (top middle panel). Let's investigate further.

```{r}
data_to_plot %>%
  group_by(rainfall) %>%
  nest() %>%
  ungroup() %>%
  slice(2) %>%
  unnest(data) %>%
  ggplot(aes(time, area_leaf, group = species_p50, colour = species_p50)) +
  geom_line() +
  facet_wrap(~rainfall, scales = "free")+
  ylab("Leaf area") +
  xlab("Time") +
  labs(colour = "p50") +
  xlim(c(0,25))
```

```{r}
focal_result <- readRDS("examples_vignettes/outputs/resolving_state_changes_shapes/rainfall_1.76p501_2.63p502_0.93lifetime_50.RDS")
```

```{r}
focal_parameters <- focal_result[[2]]
```

Let's first just re-run the result, but just for 25 years

Set base parameters

```{r}
p0 <- scm_base_parameters("FF16w")
```

Define a number of hyper-parameterisations, including the relationship between K_s and WD

```{r}
p_50_2_K_s <- function(p50){
  1.638999*(p50/2)^(-1.38)
}

calc_vul_b <- function(p_50, c){
  num <- p_50
  den <- (-log(1-50/100))^(1/c)
  num/den
}


calc_psi_crit <- function(b,c) {
  b*(log(1/0.05))^(1/c)
}
```

Run the models, setting the max patch lifetime, the p50s, and hyperparametersising K_s, b, psi_ crit

```{r}
# set default values 
run_FF16w_model <- function(inputs){
  

  ctrl = scm_base_control()

  for(v in names(ctrl)){
    if(length(inputs[[v]]) > 0){
    if(!is.na(inputs[[v]])){
    ctrl[[v]] <- inputs[[v]]
    }
    }
  }
  
  p0 <- scm_base_parameters("FF16w")
  p0$max_patch_lifetime <- inputs$max_patch_lifetime

  p50_1 <- inputs$p50_1
  p50_2 <- inputs$p50_2

  if(is.na(inputs$epsilon_leaf)){
    epsilon_leaf = 0.00001
  } else{
    epsilon_leaf = inputs$epsilon_leaf
  }

  ## increase birth rates to 10 or 50
  
  p1 <- expand_parameters(trait_matrix(c(p50_1, p50_2), "p_50"), p0, mutant=FALSE, birth_rate_list = c(1,1))
  
  p1$strategies[[1]]$K_s <- p_50_2_K_s(p50_1)
  p1$strategies[[1]]$b <- calc_vul_b(p50_1, p1$strategies[[1]]$c)
  p1$strategies[[1]]$psi_crit <- calc_psi_crit(p1$strategies[[1]]$b, p1$strategies[[1]]$c)
  p1$strategies[[1]]$epsilon_leaf <- epsilon_leaf
  p1$strat
  p1$strategies[[2]]$K_s <- p_50_2_K_s(p50_2)
  p1$strategies[[2]]$b <- calc_vul_b(p50_2, p1$strategies[[2]]$c)
  p1$strategies[[2]]$psi_crit <- calc_psi_crit(p1$strategies[[2]]$b, p1$strategies[[2]]$c)
  p1$strategies[[2]]$epsilon_leaf <- epsilon_leaf
  
  env <- make_environment("FF16w", soil_initial_state = rep(0.5, 1), rainfall = inputs$rainfall)
  time1 <- system.time(result <- build_schedule(p1, env, ctrl))
  time2 <- system.time(result <- run_scm_collect(result, env, ctrl))
  return(list(result, time1, time2))
}
```

Because I'm also looking to see where the `plant` model is breaking at the momemnt, I can use the `safely` function to run the function in a map or for loop, and where it breaks, I can ensure that it continues running, and saves the error for the defined parameters so that I can go back through and look at them later. 

```{r}
poss_run_plant = safely(.f = run_FF16w_model, otherwise = "Error")
```

Here, I set some random inputs for rainfall, p50_1, p50_2. I also defined rho as either NA (which will then be defined via hyperparametersiation depedning on p50, or set it at a constant vlaue of 0.6, which is the average value in `austraits`.)

```{r}
inputs <- expand_grid(rainfall = focal_parameters$rainfall, p50_1 = focal_parameters$p50_1, p50_2 = focal_parameters$p50_2, max_patch_lifetime = 25, schedule_eps = NA, ode_tol_abs = NA, ode_tol_rel = NA, epsilon_leaf = NA) 
```

```{r}
plan(multisession, workers = 4)
```

```{r echo=TRUE}
run_and_save_plant_water_model <- function(..., save = FALSE){
  input_parameters <- tibble(...)

  if(save == TRUE){
  if(!file.exists("examples_vignettes/outputs/resolving_state_changes_shapes")){
  dir.create("examples_vignettes/outputs/resolving_state_changes_shapes")
  }
  
  dir <- "examples_vignettes/outputs/resolving_state_changes_shapes/"

  
  filename <-paste("rainfall_", round(input_parameters$rainfall,2), "p501_", round(input_parameters$p50_1, 2), "p502_", round(input_parameters$p50_2, 2), "lifetime_", input_parameters$max_patch_lifetime, ".RDS", sep="")
  path <- paste(dir, filename, sep="")
  
  if(!file.exists(path)){
  result <- poss_run_plant(input_parameters)
  result<-list(result, input_parameters)
  saveRDS(result, path)
  }
  else {
    print(paste("skipping", path, "already done", sep = " "))
  }
  } else {
  
  result <- poss_run_plant(input_parameters)
  result<-list(result, input_parameters)
  
  return(result)
  }
  
  
  return
}
```

```{r echo=TRUE}

focal_result_reproduced <- pmap(inputs, run_and_save_plant_water_model)

tibble(result = list(focal_result_reproduced[[1]][[1]]$result), parameters = focal_result_reproduced[[1]][[2]]) %>%  
  rowwise() %>%
  mutate(result =list(extract_tidy(result)))%>%
  unnest(result) %>%
  unnest(parameters) -> focal_result_reproduced_unpacked

system.time(future_pmap(inputs, run_and_save_plant_water_model))
```

```{r}
focal_result_reproduced[[1]][[1]]$result$env %>% 
  plant:::tidy_env() %>% 
  distinct(step,.keep_all = T) %>% 
  select(step, theta) %>% 
  right_join(focal_result_reproduced_unpacked) %>%
  select(step, time, species, area_leaf, p50_1, p50_2, rainfall, theta) %>% 
  group_by(p50_1, p50_2, rainfall) %>%
  mutate(run = cur_group_id()) %>%
  group_by(step, time, p50_1, p50_2, rainfall) %>%
  mutate(total_leaf = sum(area_leaf), leaf_frac = area_leaf/total_leaf) %>%
  ungroup() %>%
  mutate(species_p50 = if_else(species == 1, p50_1, p50_2)) %>%
  group_by(rainfall, run) %>%
  nest() %>%
  ungroup() %>%
  distinct(rainfall, .keep_all = TRUE) %>%
  unnest(data)  -> data_to_plot
  
  data_to_plot %>%
  ggplot(aes(time, area_leaf, group = species_p50, colour = species_p50)) +
  geom_line() +
  geom_line(aes(x = time, y = -0.1, size = theta))
  facet_wrap(~rainfall, scales = "free")+
  ylab("Leaf area") +
  xlab("Time") +
  labs(colour = "p50")
```

```{r}
ctrl = scm_base_control()

p0 <- scm_base_parameters("FF16w")
p0$max_patch_lifetime <- 25
  
p50_1 <- inputs$p50_1

if(is.na(inputs$epsilon_leaf)){
    epsilon_leaf = 0.00001
} else{
    epsilon_leaf = inputs$epsilon_leaf
  }
  ## increase birth rates to 10 or 50
  
  p1 <- expand_parameters(trait_matrix(c(p50_1), "p_50"), p0, mutant=FALSE, birth_rate_list = c(1))
  
  p1$strategies[[1]]$K_s <- p_50_2_K_s(p50_1)
  p1$strategies[[1]]$b <- calc_vul_b(p50_1, p1$strategies[[1]]$c)
  p1$strategies[[1]]$psi_crit <- calc_psi_crit(p1$strategies[[1]]$b, p1$strategies[[1]]$c)
  p1$strategies[[1]]$epsilon_leaf <- epsilon_leaf
 
  env <- make_environment("FF16w", soil_initial_state = rep(0.5, 1), rainfall = inputs$rainfall)
  system.time(result <- build_schedule(p1, env, ctrl))
  system.time(result <- run_scm_collect(result, env, ctrl))
```

```{r}
result %>%
  tidy_patch() %>%
  FF16_expand_state() %>%
  pluck("species") %>%
  integrate_over_size_distribution() %>%
    mutate(p50 = inputs$p50_1) -> species_1

result$env %>%
  plant:::tidy_env() %>%
  select(step, theta) %>%
  distinct(step, .keep_all = T) %>%
  right_join(species_1)-> species_1
```


```{r}
ctrl = scm_base_control()

p0 <- scm_base_parameters("FF16w")
p0$max_patch_lifetime <- 25
  
p50_1 <- inputs$p50_2

if(is.na(inputs$epsilon_leaf)){
    epsilon_leaf = 0.00001
} else{
    epsilon_leaf = inputs$epsilon_leaf
  }
  ## increase birth rates to 10 or 50
  
  p1 <- expand_parameters(trait_matrix(c(p50_1), "p_50"), p0, mutant=FALSE, birth_rate_list = c(1))
  
  p1$strategies[[1]]$K_s <- p_50_2_K_s(p50_1)
  p1$strategies[[1]]$b <- calc_vul_b(p50_1, p1$strategies[[1]]$c)
  p1$strategies[[1]]$psi_crit <- calc_psi_crit(p1$strategies[[1]]$b, p1$strategies[[1]]$c)
  p1$strategies[[1]]$epsilon_leaf <- epsilon_leaf
 
  env <- make_environment("FF16w", soil_initial_state = rep(0.5, 1), rainfall = inputs$rainfall)
  system.time(result <- build_schedule(p1, env, ctrl))
  system.time(result <- run_scm_collect(result, env, ctrl))
```


```{r}
result %>%
  tidy_patch() %>%
  FF16_expand_state() %>%
  pluck("species") %>%
  integrate_over_size_distribution() %>%
  mutate(species = "2", p50 = inputs$p50_2) -> species_2

result$env %>%
  plant:::tidy_env() %>%
  select(step, theta) %>%
  distinct(step, .keep_all = T) %>%
  right_join(species_2)-> species_2
```

```{r}
bind_rows(species_1, species_2) %>%
  ggplot(aes(x= time, y = area_leaf)) +
  geom_line(aes(colour = p50, group = p50)) +
  geom_line(aes(x = time, y = theta,colour = p50, group = p50))

```

Lets start experimenting with control parameters

```{r}

run_and_save_plant_water_model_control <- function(..., save = FALSE){
  input_parameters <- tibble(...)

  if(save == TRUE){
  if(!file.exists("examples_vignettes/outputs/resolving_state_changes_shapes/control_parameters")){
  dir.create("examples_vignettes/outputs/resolving_state_changes_shapes/control_parameters")
  }
  
  dir <- "examples_vignettes/outputs/resolving_state_changes_shapes/control_parameters/examples/"

  
  filename <-paste("rainfall_", round(input_parameters$rainfall,2), "p501_", round(input_parameters$p50_1, 2), "p502_", round(input_parameters$p50_2, 2), "lifetime_", input_parameters$max_patch_lifetime,
                   "schedule_eps", round(input_parameters$schedule_eps, 6),"ode_tol_abs", round(input_parameters$ode_tol_abs, 6),"ode_tol_rel", round(input_parameters$ode_tol_rel, 6),"epsilon_leaf", round(input_parameters$epsilon_leaf, 6),"simple_bucket",".RDS", sep="")
  path <- paste(dir, filename, sep="")
  
  if(!file.exists(path)){
  result <- poss_run_plant(input_parameters)
  result<-list(result, input_parameters)
  saveRDS(result, path)
  }
  else {
    print(paste("skipping", path, "already done", sep = " "))
  }
  } else {
  
  result <- poss_run_plant(input_parameters)
  result<-list(result, input_parameters)
  
  return(result)
  }
  
  
  return
}
```


Here, I set some random inputs for rainfall, p50_1, p50_2. I also defined rho as either NA (which will then be defined via hyperparametersiation depedning on p50, or set it at a constant vlaue of 0.6, which is the average value in `austraits`.)

```{r}
inputs <- expand_grid(rainfall = focal_parameters$rainfall, p50_1 = focal_parameters$p50_1, p50_2 = focal_parameters$p50_2, max_patch_lifetime = 25, schedule_eps = seq(0.0001, 0.005, length.out = 10), ode_tol_abs =  NA, ode_tol_rel =  NA, epsilon_leaf = NA) %>%
    slice(sample(1:n())) 

```

```{r}
future_pmap(inputs, run_and_save_plant_water_model_control, save = TRUE)

pmap(inputs, run_and_save_plant_water_model_control, save = TRUE)
```

```{r}
results_files <- list.files("examples_vignettes/outputs/resolving_state_changes_shapes/control_parameters")

extract_function <- function(file){
  dir <- "examples_vignettes/outputs/resolving_state_changes_shapes/control_parameters/"
  filename <- file
  path <- paste(dir, filename, sep="")
  
  resultRDS <- readRDS(path)
  results <- tibble(result = list(resultRDS[[1]]$result), parameters = resultRDS[[2]]) %>%
    mutate(error = ifelse(is.null(resultRDS[[1]]$error$message), "NA", resultRDS[[1]]$error$message))
  results
  }

map(results_files, extract_function) %>%
  bind_rows() -> collated_results
```

```{r}
list_or_not  <- rep(NA, nrow(collated_results))
for(i in 1:nrow(collated_results)){
  list_or_not[i] <- is.list(collated_results$result[[i]])
}

collated_results <- collated_results[list_or_not,]  
```

```{r}
extract_tidy <- function(result){
  result %>%
    tidy_patch() %>%
    FF16_expand_state() -> result
  
    result$species %>%
    integrate_over_size_distribution()
}

collated_results %>%
  rowwise() %>%
  mutate(result =list(extract_tidy(result))) -> collated_results2
```


```{r}
set.seed(123)
collated_results2 %>%
  unnest(result) %>%
  unnest(parameters) %>% 
  select(step, time, species, area_leaf, p50_1, p50_2, ode_tol_abs, ode_tol_rel, schedule_eps) %>% 
  group_by(ode_tol_abs, ode_tol_rel, schedule_eps) %>%
  mutate(run = cur_group_id()) %>%
  group_by(step, time, ode_tol_abs, ode_tol_rel, schedule_eps) %>%
  mutate(total_leaf = sum(area_leaf), leaf_frac = area_leaf/total_leaf) %>%
  ungroup() %>%
  mutate(species_p50 = if_else(species == 1, p50_1, p50_2)) %>%
  # filter(run %in% sample(unique(run),9)) %>%
  group_by(ode_tol_abs, ode_tol_rel, schedule_eps, run) %>%
  nest() %>%
  ungroup() %>%
  # distinct(ode_tol_abs, .keep_all = TRUE) %>%
  unnest(data)  -> data_to_plot
  
  data_to_plot %>%
  ggplot(aes(time, area_leaf, group = species_p50, colour = species_p50)) +
  geom_line() +
  facet_grid(ode_tol_abs~schedule_eps, scales = "free")+
  ylab("Leaf area") +
  xlab("Time") +
  labs(colour = "p50")
```


```{r}
results_files <- list.files("examples_vignettes/outputs/resolving_state_changes_shapes/control_parameters/examples")

extract_function <- function(file){
  dir <- "examples_vignettes/outputs/resolving_state_changes_shapes/control_parameters/examples/"
  filename <- file
  path <- paste(dir, filename, sep="")
  
  resultRDS <- readRDS(path)
  results <- tibble(result = list(resultRDS[[1]]$result[[1]]), parameters = resultRDS[[2]], time_build = resultRDS[[1]]$result[[2]][3], time_run = resultRDS[[1]]$result[[3]][3]) %>%
    mutate(error = ifelse(is.null(resultRDS[[1]]$error$message), "NA", resultRDS[[1]]$error$message))
  results
  }

map(results_files, extract_function) %>%
  bind_rows() -> collated_results

extract_tidy <- function(result){
  result %>%
    tidy_patch() %>%
    FF16_expand_state() -> result_species
  
    result_species$species %>%
    integrate_over_size_distribution() -> result_species
  
    result$env %>%
    plant:::tidy_env() %>%
    select(step, theta) %>%
      right_join(result_species)
}


collated_results %>%
  rowwise() %>%
  mutate(result =list(extract_tidy(result))) -> collated_results2
```

```{r}
collated_results2 %>%
  unnest(c(result)) %>%
  unnest(parameters) %>% 
  select(step, time, species, area_leaf, p50_1, p50_2, schedule_eps, theta) %>% 
  group_by( schedule_eps) %>%
  mutate(run = cur_group_id()) %>%
  group_by(step, time,schedule_eps) %>%
  mutate(total_leaf = sum(area_leaf), leaf_frac = area_leaf/total_leaf) %>%
  ungroup() %>%
  mutate(species_p50 = if_else(species == 1, p50_1, p50_2)) %>%
  # filter(run %in% sample(unique(run),9)) %>%
  group_by(schedule_eps, run) %>%
  nest() %>%
  ungroup() %>%
  # distinct(ode_tol_abs, .keep_all = TRUE) %>%
  unnest(data)  -> data_to_plot
  
  data_to_plot %>%
    mutate(schedule_eps = round(schedule_eps, digits = 6)) %>%
  ggplot(aes(time, area_leaf, group = species_p50, colour = species_p50)) +
  geom_line() +
  facet_wrap(~schedule_eps, scales = "free", nrow = 2)+
  ylab("Leaf area index") +
  xlab("Time") +
  labs(colour = "p50") +
  labs(title = "Schedule_eps") +
  theme_classic() -> a
  
    data_to_plot %>%
    mutate(schedule_eps = round(schedule_eps, digits = 6)) %>%
  ggplot(aes(time, theta, group = species_p50, colour = species_p50)) +
  geom_line() +
  facet_wrap(~schedule_eps, scales = "free", nrow = 2)+
  ylab("Soil moisture (m^3/ m^3") +
  xlab("Time") +
  labs(colour = "p50") +
  labs(title = "Schedule_eps") +
  theme_classic() -> b
  
collated_results2 %>%
  unnest(result) %>%
  unnest(parameters) %>%
  select(time_build, time_run, schedule_eps) %>%
  mutate(total_time = time_build + time_run) %>%
  ggplot(aes(x = schedule_eps, y= total_time)) +
  geom_point() +
  theme_classic() +
  ylab("Total time for computation (s)") +
  xlab("Schedule_eps") -> c

png("examples_vignettes/outputs/resolving_state_changes_shapes/control_parameters/examples/figure/time_versus_refinement.png", height = 1350, width = 1200)

cowplot::plot_grid(a, b, c, nrow = 3)

dev.off()

```

```{r}
results_files <- list.files("examples_vignettes/outputs/resolving_state_changes_shapes/control_parameters/examples")[11]

result <- readRDS(paste("examples_vignettes/outputs/resolving_state_changes_shapes/control_parameters/examples/", results_files, sep=""))
result[[1]]$result[[1]] %>%
  plant:::tidy_
```



