---
title: Report on FF16 stand
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: no
    smart: no
    theme: yeti
    code_folding: hide
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
params:
    results: provide
editor_options:
  chunk_output_type: console
---

<!-- hack to get indentation on 3rd level of floating TOC; see
https://stackoverflow.com/questions/46201753/rmarkdown-indentation-of-toc-items-in-html-output
 -->

<script>
$(document).ready(function() {
  $items = $('div#TOC li');
  $items.each(function(idx) {
    num_ul = $(this).parentsUntil('#TOC').length;
    $(this).css({'text-indent': num_ul * 10, 'padding-left': 0});
  });

});
</script>


```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
# knitr defaults
knitr::opts_chunk$set(echo=TRUE, cache=FALSE, message=FALSE, warning=FALSE)

options(
  # default for table format  
  knitr.table.format = "html", 
  # remove warnings from dplyr about "summarise"
  dplyr.summarise.inform = FALSE,
  readr.show_col_types = FALSE
  )

library(ggplot2)
library(dplyr)
library(purrr)
library(tidyr)
library(readr)
library(ggridges)

theme_set(theme_classic())

select_closest <- function(x, targets) {
  f <- function(target, x) {
    dist <- abs(x - target)
    x[which(dist == min(dist))]
  }

  x <- unique(x)

  targets %>%
    purrr:::map_dbl(f, x)
}

```

```{r, echo = FALSE, eval=FALSE}

# this is not run by default, just some code to generate som example data, if needed 
p0 <- scm_base_parameters("FF16", "FF16_Env")
p0$strategy_default$recruitment_decay <- 5
p0$strategy_default$a_dG2 <- 30

hyperpar <- make_FF16_hyperpar(B_dI1 = 0)

traits <- trait_matrix(c(0.2), c("lma"))
p1 <- expand_parameters(traits, p0, hyperpar = hyperpar, mutant = FALSE)
results <- build_schedule(p1)
results <- run_scm_collect(results)


```

This report
 
# Inputs

## Site properties

The site was simulated with following properties

- Latitude: input to hyper par function, not accessible in output
- Productivity: input to hyper par function, not accessible in output
- Solar inputs  / cycles

## Species 

The simulation was run with XX species.

### Parameters

The following parameters were included in the model
```{r}
p <- results$p

extract_strategy <- function(strat) {
  ex <- c("control" , "collect_all_auxiliary",   "birth_rate_x", "birth_rate_y", "is_variable_birth_rate")

  x <- strat[!(names(strat) %in% ex)]
  
  tibble(parameter = names(x), value = unlist(x))
}

pars <-  
  purrr::map_df(p$strategies, extract_strategy, .id = "species") %>% 
  mutate(species = paste("sp", species)) %>%
  bind_rows(
    extract_strategy(p1$strategy_default) %>% mutate(species = "default")
  ) %>% 
  mutate(value = format(value, scientific = TRUE, drop0trailing = TRUE)) %>%
  pivot_wider(values_from = value, names_from = species)

pars_def <- 
 system.file("docs/FF16", "FF16-params-core.csv", package = "plant") %>% read_csv() %>%
  rename("parameter" = "Code")

names(pars_def) <- tolower(names(pars_def))

pars_def %>% 
  left_join(by = "parameter", pars) %>% 
  select(description, parameter, everything()) %>% select(-symbol) %>% 
  knitr::kable(
    align = "l",
    caption = "Variable names and definitions in the demographic model of the `plant` package."
  )
```

Traits

- Comparisons to data (Austraits)
- Along tradeoff curves(requires data from hyperpar?)

### Birth rates

### Leaf photosynthesis

Species had the following potential leaf photosynthetic rates, calculated by integrating instantaneous photosynthesis across the solar path trhoughout the year.

```{r}
E <- seq(0,1, by=0.01)

leaf_rates <- 
  p$strategies %>% purrr::map_df(~tibble(E, A = .x$a_p1 * E / (E+ .x$a_p2)),.id = "species") %>% 
mutate(
  species = paste("sp", species)
  ) 
  
leaf_rates %>% 
ggplot(aes(E, A, group = species, col= species)) + 
geom_line() +
labs(
  title = "Annual leaf photosynthesis",
  x = "Canopy openness (0-1)",
  y = "Photosynthesis (mol/m2/yr)"
)

```

# Individual trajectoires

Compare to BAAD (Becca)

# Stand dynamics - size structured 

For the plots below we're going to use the tidy outputs format of the results.

```{r}
results_tidy_expand <- 
  results %>% 
  tidy_patch() %>% 
  FF16_expand_state()

data_species <-
  results_tidy_expand$species %>%
  drop_na()

data_species_tot <-
  data_species %>%
  integrate_over_size_distribution()

canopy <-
  results_tidy_expand$env$canopy %>%
  group_by(step) %>% 
  mutate(
    # LAI at height
    LAI_above = -log(canopy_openness)/0.5,
    # Cumulative LAI from the rgound up
    LAI_below = max(LAI_above) - LAI_above
  ) %>% ungroup()


target_ages <- c(0.1, seq(1, 5), seq(10, 50, by = 5), seq(70, results_tidy_expand$species$time %>% max(), by = 20))

```

## Size distributions

SIZE - DENSITY

```{r}
data_species %>%
  plot_size_distribution()
```

- Height 
- relative scale?
- Interpreting density

## Growth rates

Total
Size dependent
Growth vs independent?


```{r}

get_dt <- function(y,x) {
  c(diff(y)/diff(x), NA)
}

vars <- c("height", "diameter_stem", "mass_above_ground")

growth_rates <-
  data_species %>% 
  select(time, species, node, height, mortality, fecundity, any_of(vars)) %>%
  group_by(species, node) %>%
  mutate(
    dt = c(diff(time), NA),
    across(c("height", "mortality", "fecundity", any_of(vars)), ~ c(diff(.x), NA) / dt, .names = "{.col}_dt")
  ) %>% 
  ungroup() %>%
  filter(time %in% select_closest(time, target_ages)) %>% 
  mutate(
    species = paste("sp", species),
    time = round(time)) %>%
  select(-dt) %>%
  select(time, species, height, ends_with("dt"))
  
growth_rates_max <- 
  growth_rates %>%
  group_by(time, species) %>%
  slice(1) %>%
  ungroup() %>%
  pivot_longer(ends_with("dt"))

growth_rates %>% 
  select(-mortality_dt, -fecundity_dt) %>%
  pivot_longer(ends_with("dt")) %>%
  ggplot(aes(x = height, y = value, label = time, group = time, col = time)) +
  geom_line() +
  geom_text(data = growth_rates_max %>% filter(!name %in% c("mortality_dt", "fecundity_dt")), nudge_x = 0.5) +
  facet_grid(vars(name), vars(species), scales="free") +
  labs(
    title = "Growth rates vs size",
    x = "Individual height (m)",
    y = "Growth rate (unit / yr)"
  ) 
```
## Mortality

```{r}

growth_rates %>%
  select(species, height, time, mortality_dt) %>%
  pivot_longer(ends_with("dt")) %>%
  ggplot(aes(x = height, y = value, label = time, group = time, col = time)) +
  geom_line() +
  geom_text(data = growth_rates_max %>% filter(name %in% c("mortality_dt")), nudge_x = 0.5) +
  facet_grid(cols= vars(species), scales = "free") +
  labs(
    title = "Mortality rates vs size",
    x = "Individual height (m)",
    y = "Mortality rate ( / yr)"
  )
```

Todo:

- Growth vs independent?

## Fecundity


```{r}

growth_rates %>%
  select(species, height, time, fecundity_dt) %>%
  pivot_longer(ends_with("dt")) %>%
  ggplot(aes(x = height, y = value, label = time, group = time, col = time)) +
  geom_line() +
  geom_text(data = growth_rates_max %>% filter(name %in% c("fecundity_dt")), nudge_x = 0.5) +
  facet_grid(cols=vars(species), scales = "free") +
  labs(
    title = "Fecundity rates vs size",
    x = "Individual height (m)",
    y = "Fedcundity rate ( / yr)"
  )
```


# Stand dynamics - aggregate outputs

## Leaf area

The following plot shows the cumulative leaf area for each species in the stand.

```{r}
data_species_tot %>%
  ggplot(aes(time, area_leaf, colour = species, fill=species)) +
  geom_line() + 
  xlab("Patch age (yr") +
     ylab("Leaf area index (m2/m2)")
```

The following plot shows the amount of leaf area contributed by plants of different height in the stand.

```{r}

data_species %>%
  filter(time %in% select_closest(time, target_ages)) %>%
  ggplot(aes(x = height, height = density * area_leaf, y = time, group = time, fill = species)) +
  geom_density_ridges(stat = "identity", scale = 2) +
  # scale_y_continuous(expand = c(0, 0)) +
  # scale_x_continuous(expand = c(0, 0)) + # remove unneeded padding
  #  coord_cartesian(clip = "off") + # to avoid clipping of the very top of the top ridgeline
  labs(
    title = "Leaf area contributed by individual height",
    y = "Patch age (yr)",
    x = "Individual height (m)"
  ) +
  theme_ridges() +
  coord_flip()

```

```{r}
trapezium_segments <- function(x, y) c(0, diff(x) * 0.5 * (y[-length(y)] + y[-1]))

cumulative_trapezium <- function(x,y) {
  cumsum(trapezium_segments(x,y))
}

rev_cumulative_trapezium <- function(x,y) {
  rev(cumsum(trapezium_segments(rev(x), rev(y))))
}

d2 <- 
  data_species %>%
  stats::na.omit() %>%
  filter(time %in% select_closest(time, target_ages)) %>% 
  mutate(species = paste("sp ", species)) %>%
  group_by(time, species) %>%
  mutate(
    LAI_below = 
    rev_cumulative_trapezium(height, density * area_leaf)
  ) %>% ungroup()
  
d2_com <- d2 %>%
  bind_rows(
    canopy %>% mutate(species="canopy") %>%
      filter(time %in% select_closest(time, target_ages))
   )

d2_max <- d2_com %>%
    group_by(time, species) %>%
    filter(height == max(height)) %>%
    ungroup()

d2 %>%
  ggplot(aes(x = height, y=time, height = LAI_below, group = time, col = species)) +  
   geom_density_ridges(stat = "identity", scale = 2) +   
   labs(
     title = "Cumulutive leaf area by individual height",
     y = "Patch age (yr)",
     x = "Individual height (m)"
   ) +
   theme_ridges() +
   coord_flip()

d2_com %>%
  ggplot(aes(y = height, x = LAI_below, label = round(time), group = time, col = time)) +
  geom_line() +
  geom_text(data = d2_max, nudge_x = 0.1) +
  labs(
    title = "Cumulutive leaf area from ground, total (left) and by individual (right)",
    x = "Total leaf area from ground (m2/m2)",
    y = "Individual height (m)"
  ) + facet_wrap(~species)

```

## Basal area 


```{r}
data_species_tot %>%
  ggplot(aes(time, area_stem, colour = species)) +
  geom_line() + 
  xlab("Patch age (yr") +
  ylab("Total basal area (m2/m2)")
```

## BIOMASS
Tissues 

```{r}
v <- c("mass_heartwood", "mass_sapwood", "mass_bark", "mass_leaf")

data_long <-
  data_species_tot %>%
  select(time, species, one_of(v)) %>%
  pivot_longer(cols = starts_with("mass"), names_to = "tissue")

data_long$tissue <- factor(data_long$tissue, levels = v)

species_names <- tibble(
  species = unique(data_long$species),
  species_name = paste("Species", species)
)

data_long %>%
  left_join(by = "species", species_names) %>%
  ggplot(aes(time, value, fill = tissue)) +
  geom_area() +
  labs(x = "Patch age (yr)", y = "Above ground mass (kg/m2)") +
  theme_classic() +
  xlim(c(0, 100)) +
  facet_wrap(~species_name)
```

## Carbon budgets 

### NPP

### Turnover


## Environment

### Light availability

```{r}

d2 <-
    canopy %>% mutate(species = "canopy") %>%
    filter(time %in% select_closest(time, target_ages)) %>% 
    mutate(time = round(time))

d2_max <- d2 %>%
  group_by(time, species) %>%
  slice(n())

d2 %>%
  ggplot(aes(x = height, y = canopy_openness, label = time, group = time, col = time)) +
  geom_line() +
  geom_text(data = d2_max, nudge_y = 0.05) +
  labs(
    title = "Canopy openess through time",
    x = "height from ground (m)",
    y = "Canopy openness (0-1)"
  )
```




