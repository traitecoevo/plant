<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patch-level dynamics • plant</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Patch-level dynamics">
<meta property="og:description" content="plant">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">plant</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
    Home
  </a>
</li>
<li>
  <a href="../articles/plant.html">
    <span class="fas fa-tree"></span>
     
    Getting Started
  </a>
</li>
<li>
  <a href="../reference/index.html">
    <span class="fas fa-list"></span>
     
    Reference
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-book"></span>
     
    Theory
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/demography.html">Demography of plants, patches, and metacommunities</a>
    </li>
    <li>
      <a href="../articles/physiology.html">The FF16 strategy</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-file-code-o"></span>
     
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/individuals.html">Individual plants</a>
    </li>
    <li>
      <a href="../articles/patch.html">Patches of competing plants</a>
    </li>
    <li>
      <a href="../articles/equilibrium.html">Finding demographic equilibrium</a>
    </li>
    <li>
      <a href="../articles/emergent.html">Emergent properties of patches</a>
    </li>
    <li>
      <a href="../articles/fitness.html">Calculating fitness</a>
    </li>
    <li>
      <a href="../articles/cohort_spacing.html">The cohort spacing algorithm</a>
    </li>
    <li>
      <a href="../articles/parameters.html">Changing parameters</a>
    </li>
    <li>
      <a href="../articles/strategy.html">Implementing a new strategy</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/developer_notes.html">
    <span class="fas fa-terminal"></span>
     
    Developer Notes
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../news/index.html">
    <span class="fas fa-newspaper-o"></span>
     
    News
  </a>
</li>
<li>
  <a href="https://github.com/traitecoevo/plant">
    <span class="fas fa-github fa-lg"></span>
     
    Github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Patch-level dynamics</h1>
                        <h4 class="author">Rich FitzJohn</h4>
                        <h4 class="author">Daniel Falster</h4>
            
            <h4 class="date">2021-02-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/traitecoevo/plant/blob/master/vignettes/patch.Rmd"><code>vignettes/patch.Rmd</code></a></small>
      <div class="hidden name"><code>patch.Rmd</code></div>

    </div>

    
    
<div id="background" class="section level1">
<h1 class="hasAnchor">
<a href="#background" class="anchor"></a>Background</h1>
<p>Having explored the Individual class in (Individual-level properties)[<a href="https://traitecoevo.github.io/plant/articles/individuals.html" class="uri">https://traitecoevo.github.io/plant/articles/individuals.html</a>], the aim here is to use <code>plant</code> to investigate dynamics of many individuals within a single patch. First we instantiate the basic parameters of the <code>FF16</code> strategy, particularly the probability that a patch is disturbed (via <code>disturbance_mean_interval</code>):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/traitecoevo/plant">plant</a></span><span class="op">)</span>

<span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scm_base_parameters.html">scm_base_parameters</a></span><span class="op">(</span><span class="st">"FF16"</span><span class="op">)</span>

<span class="va">params</span><span class="op">$</span><span class="va">disturbance_mean_interval</span> <span class="op">&lt;-</span> <span class="fl">30.0</span></code></pre></div>
</div>
<div id="one-patch" class="section level1">
<h1 class="hasAnchor">
<a href="#one-patch" class="anchor"></a>One patch</h1>
<p>Next, we configure a patch containing a single species:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">patch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand_parameters.html">expand_parameters</a></span><span class="op">(</span><span class="fu"><a href="../reference/trait_matrix.html">trait_matrix</a></span><span class="op">(</span><span class="fl">0.0825</span>, <span class="st">"lma"</span><span class="op">)</span>, <span class="va">params</span>, mutant <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<!-- TODO: rename SCM to solve_characteristic_method (issue: \#206) -->
<p>and run the <code>plant</code> characteristic solver to step the equations defining cohorts of individuals forward in time:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_scm_collect.html">run_scm_collect</a></span><span class="op">(</span><span class="va">patch</span><span class="op">)</span></code></pre></div>
</div>
<div id="section" class="section level1">
<h1></h1>
<p><code>run_scm_collect</code> collects information about the state of the system at every ODE step:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "time"          "species"       "env"           "seed_rain"     "patch_density" "p"</code></pre>
<p>Entries are: * time: time of the step * species: a list with the state of each species (in this case there is only 1). The contents is a 3D array of variable / time step / cohort * env: a list containing 2D splines that describe the competitive environment of the patch at each step (e.g a matrix of canopy openness at a given height in the FF16 strategy) * seed_rain: the seed rain output from the patch during it’s development * p: a copy of the input parameters</p>
<p>First we explore patch state:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">t</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">time</span>
<span class="va">h</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"height"</span>, , <span class="op">]</span></code></pre></div>
<p>here <code>h</code> is two of the three dimensions of the state array; each row is a <em>time</em> and each column is a <em>cohort</em>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 142 141</code></pre>
<p>While the solver ran the patch ODEs for 142 steps, the time points are not evenly distributed:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Round.html">signif</a></span><span class="op">(</span><span class="va">t</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">10</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">142</span><span class="op">)</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0e+00 1e-04 2e-02 2e+01 1e+02</code></pre>
<p>higher temporal resolution is needed to resolve early patch development, where small differences are magnified through competitive feedbacks. Our patch ran for 105 yrs, but the solver spent half the recorded steps exploring the first year alone. More on timing can be found in the <a href="https://traitecoevo.github.io/plant/articles/cohort_spacing.html">cohort scheduling algorithm</a>.</p>
<p>Cohorts are introduced at each time-step, except the last. At time step <span class="math inline">\(i\)</span>, the rows of <code>h</code> record the height of all previously introduced cohorts in the patch:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">h</span><span class="op">[</span><span class="fl">10</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></code></pre></div>
<pre><code>##  [1] 0.3920954 0.3920902 0.3920850 0.3920798 0.3920746 0.3920694 0.3920642 0.3920589 0.3920537 0.3920458</code></pre>
<p>with <code>NA</code> for cohorts that have not yet been introduced:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">h</span><span class="op">[</span><span class="fl">10</span>, <span class="fl">11</span><span class="op">]</span></code></pre></div>
<pre><code>## [1] NA</code></pre>
<p>Similarly, the <span class="math inline">\(j\)</span>th column of <code>h</code> records the heights of a particular cohort:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">h</span><span class="op">[</span><span class="fl">10</span><span class="op">:</span><span class="fl">19</span>, <span class="fl">10</span><span class="op">]</span></code></pre></div>
<pre><code>##  [1] 0.3920458 0.3920537 0.3920617 0.3920696 0.3920776 0.3920935 0.3921094 0.3921253 0.3921412 0.3921571</code></pre>
<p>with <code>NA</code> at time steps before it was introduced:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">h</span><span class="op">[</span>, <span class="fl">10</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 9</code></pre>
<p>With a single species there is always one more time step than cohort introduction, with the last two steps having the same number of cohorts. With multiple species there can be more time steps than cohort introductions, as we’ll record data every cohort introduction for <em>either</em> species, each of which will be refined to different schedules.</p>
<p>In the <code>FF16</code> strategy, Individuals increase in height with respect to time, but because they are competing the growth rate depends on the state of the environment (e.g. the amount of shading above an Individual’s canopy), in addition to size dependent growth.</p>
<!-- TODO: Dead link- "(see vignette:plant)" -->
<p>We can plot the trajectories of cohorts developing within a patch over time:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">h</span>, lty<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="fu"><a href="../reference/make_transparent.html">make_transparent</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">0.25</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"l"</span>,
        las<span class="op">=</span><span class="fl">1</span>, xlab<span class="op">=</span><span class="st">"Time (years)"</span>, ylab<span class="op">=</span><span class="st">"Height (m)"</span><span class="op">)</span></code></pre></div>
<p><img src="figure/patch__unnamed-chunk-12-1.png"></p>
<p>The light environment is stored over each time step, meaning that we can also plot how it changes during patch development:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Set limits</span>
<span class="va">xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.1</span><span class="op">)</span>
<span class="va">ylim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">env</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">env</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="st">"height"</span><span class="op">]</span><span class="op">)</span>

<span class="co"># Draw the spline at each step</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="cn">NA</span>, xlim<span class="op">=</span><span class="va">xlim</span>, ylim<span class="op">=</span><span class="va">ylim</span>, las<span class="op">=</span><span class="fl">1</span>, xlab<span class="op">=</span><span class="st">"Canopy openness"</span>, ylab<span class="op">=</span><span class="st">"Height (m)"</span><span class="op">)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="va">result</span><span class="op">$</span><span class="va">env</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">i</span><span class="op">[</span>, <span class="st">"canopy_openness"</span><span class="op">]</span>, <span class="va">i</span><span class="op">[</span>, <span class="st">"height"</span><span class="op">]</span>, col<span class="op">=</span><span class="st">"grey"</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Add labels at specific times</span>
<span class="va">blues</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#DEEBF7"</span>, <span class="st">"#C6DBEF"</span>, <span class="st">"#9ECAE1"</span>, <span class="st">"#6BAED6"</span>,
           <span class="st">"#4292C6"</span>, <span class="st">"#2171B5"</span>, <span class="st">"#08519C"</span>, <span class="st">"#08306B"</span><span class="op">)</span>

<span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">20</span>, <span class="fl">40</span>, <span class="va">result</span><span class="op">$</span><span class="va">time</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span><span class="op">(</span><span class="va">blues</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span><span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">env</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">times</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="va">result</span><span class="op">$</span><span class="va">time</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">]</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="st">"canopy_openness"</span><span class="op">]</span>, <span class="va">x</span><span class="op">[</span>, <span class="st">"height"</span><span class="op">]</span>, col<span class="op">=</span><span class="va">cols</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

  <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="st">"height"</span><span class="op">]</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/points.html">points</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">y</span>, pch<span class="op">=</span><span class="fl">19</span>, col<span class="op">=</span><span class="va">cols</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/text.html">text</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/graphics/strwidth.html">strwidth</a></span><span class="op">(</span><span class="st">"x"</span><span class="op">)</span>, <span class="va">y</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">times</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="st">"years"</span><span class="op">)</span>,
       adj<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p><img src="figure/patch__unnamed-chunk-13-1.png"> initally (bottom right) all cohorts in the patch are short and the canopy is rather open (close to one). In later stages of patch development, we see that only the tallest individuals experience an open canopy. Notably, the canopy openness experienced by shorter individuals fluctuates as older individuals die and canopy gaps are filled in.</p>
<p>This is best shown by plotting the canopy openness at ground level over time:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">env</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"canopy_openness"</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">time</span>, <span class="va">y</span>, type<span class="op">=</span><span class="st">"l"</span>, las<span class="op">=</span><span class="fl">1</span>,
     ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, xlab<span class="op">=</span><span class="st">"Time (years)"</span>, ylab<span class="op">=</span><span class="st">"Canopy openness"</span><span class="op">)</span></code></pre></div>
<p><img src="figure/patch__unnamed-chunk-14-1.png"></p>
<p>Again, the waves here are show rounds of recruitment and self thinning. Mortality is not instantaneous, so monocultures (patches of one species) recruit to a density that generates a canopy that they cannot survive under.</p>
</div>
<div id="multiple-patches" class="section level1">
<h1 class="hasAnchor">
<a href="#multiple-patches" class="anchor"></a>Multiple patches</h1>
<p>In the <code>FF16</code> strategy, leaf area index (LAI) is the driver that controls the canopy openness (via the light extinction coefficient <code>params$k_I</code>, following exponential extinction). This is not returned by <code>run_scm_collect</code> so instead we need to rebuild patches using <code>scm_patch</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">patches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>, <span class="va">scm_patch</span>, <span class="va">result</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">patches</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 142</code></pre>
<p>Each element of the resulting list is a Patch object, the same as was observed when running the model, but at each time step. This allows us to interrogate (via the internal functions of the Patch), rather than exploring summary results. Here we calculate the competition experienced at ground level (height = 0) in terms of LAI:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lai</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">patches</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="fu">compute_competition</span><span class="op">(</span><span class="fl">0.0</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">time</span>, <span class="va">lai</span>, type<span class="op">=</span><span class="st">"l"</span>, las<span class="op">=</span><span class="fl">1</span>, xlab<span class="op">=</span><span class="st">"Time (years)"</span>, ylab<span class="op">=</span><span class="st">"Leaf area index"</span><span class="op">)</span></code></pre></div>
<p><img src="figure/patch__unnamed-chunk-16-1.png"></p>
</div>
<div id="multi-species-patches" class="section level1">
<h1 class="hasAnchor">
<a href="#multi-species-patches" class="anchor"></a>Multi-species patches</h1>
<p>If multiple species are grown at once, they compete with one another. This adds a second species – with a higher leaf mass area (LMA) than the first species – to the population (see [Comparing Indivudals][<a href="https://traitecoevo.github.io/plant/articles/individuals.html#comparing-individuals" class="uri">https://traitecoevo.github.io/plant/articles/individuals.html#comparing-individuals</a>] for a refresher on species traits)</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">patch_2sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expand_parameters.html">expand_parameters</a></span><span class="op">(</span><span class="fu"><a href="../reference/trait_matrix.html">trait_matrix</a></span><span class="op">(</span><span class="fl">0.2625</span>, <span class="st">"lma"</span><span class="op">)</span>, <span class="va">patch</span>, mutant <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>Then collect the patch-level dynamics:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">result_2sp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_scm_collect.html">run_scm_collect</a></span><span class="op">(</span><span class="va">patch_2sp</span><span class="op">)</span></code></pre></div>
<p>We can plot the development of each species within the patch:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">t2</span> <span class="op">&lt;-</span> <span class="va">result_2sp</span><span class="op">$</span><span class="va">time</span>
<span class="va">h1</span> <span class="op">&lt;-</span> <span class="va">result_2sp</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"height"</span>, , <span class="op">]</span>
<span class="va">h2</span> <span class="op">&lt;-</span> <span class="va">result_2sp</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"height"</span>, , <span class="op">]</span>

<span class="va">cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#e34a33"</span>, <span class="st">"#045a8d"</span><span class="op">)</span>

<span class="co"># Species 1 - red</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">h1</span>, lty<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="fu"><a href="../reference/make_transparent.html">make_transparent</a></span><span class="op">(</span><span class="va">cols</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fl">.25</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"l"</span>,
        las<span class="op">=</span><span class="fl">1</span>, xlab<span class="op">=</span><span class="st">"Time (years)"</span>, ylab<span class="op">=</span><span class="st">"Height (m)"</span><span class="op">)</span>

<span class="co"># Species 2 - blue</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">h2</span>, lty<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="fu"><a href="../reference/make_transparent.html">make_transparent</a></span><span class="op">(</span><span class="va">cols</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="fl">.25</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="figure/patch__unnamed-chunk-19-1.png"></p>
<p>Alternatively we can compare the growth of the low LMA species (red) in a patch by itself or with another species:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Monoculture patch (black)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matplot</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">h</span>, lty<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="fu"><a href="../reference/make_transparent.html">make_transparent</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="fl">.25</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"l"</span>,
        las<span class="op">=</span><span class="fl">1</span>, xlab<span class="op">=</span><span class="st">"Time (years)"</span>, ylab<span class="op">=</span><span class="st">"Height (m)"</span><span class="op">)</span>

<span class="co"># Two species patch (red)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html">matlines</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">h1</span>, lty<span class="op">=</span><span class="fl">1</span>, col<span class="op">=</span><span class="fu"><a href="../reference/make_transparent.html">make_transparent</a></span><span class="op">(</span><span class="va">cols</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fl">.25</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="figure/patch__unnamed-chunk-20-1.png"></p>
<p>This shows that the additional species does not significantly affect the growth of the <em>initial</em> wave of cohorts (because the second species is growing more slowly and is shorter than the first species). However, once canopy closure has occurred (around year 5), subsequent waves of arriving cohorts are competitively suppressed, slowed or eliminated.</p>
<p>The dynamics are easier to see when cohort trajectories are weighted by cohort density (some of the lines here represent cohorts at close to zero density). Log density is available as a characteristic variable of all <code>plant</code> strategies:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Relativise the log densities onto (-4, max)</span>
<span class="va">d1</span> <span class="op">&lt;-</span> <span class="va">result_2sp</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"log_density"</span>, , <span class="op">]</span>
<span class="va">d2</span> <span class="op">&lt;-</span> <span class="va">result_2sp</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"log_density"</span>, , <span class="op">]</span>
<span class="va">rel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">xmin</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">&lt;</span> <span class="va">xmin</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">xmin</span>
  <span class="va">xmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>
  <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">xmin</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">xmax</span> <span class="op">-</span> <span class="va">xmin</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">rd1</span> <span class="op">&lt;-</span> <span class="fu">rel</span><span class="op">(</span><span class="va">d1</span>, <span class="op">-</span><span class="fl">4</span><span class="op">)</span>
<span class="va">rd2</span> <span class="op">&lt;-</span> <span class="fu">rel</span><span class="op">(</span><span class="va">d2</span>, <span class="op">-</span><span class="fl">4</span><span class="op">)</span>

<span class="co"># R doesn't seem to offer a way to plot lines that vary in colour, so</span>
<span class="co"># this is quite roundabout using `segments`, shaded by the density at</span>
<span class="co"># the first part of the line segment:</span>
<span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">t2</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">t2</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">h1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">h1</span><span class="op">)</span><span class="op">)</span>
<span class="va">col1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="../reference/make_transparent.html">make_transparent</a></span><span class="op">(</span><span class="va">cols</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">rd1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">d1</span><span class="op">)</span><span class="op">)</span>
<span class="va">col2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="../reference/make_transparent.html">make_transparent</a></span><span class="op">(</span><span class="va">cols</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, <span class="va">rd2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">d2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="cn">NA</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">t2</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">h1</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,
     las<span class="op">=</span><span class="fl">1</span>, xlab<span class="op">=</span><span class="st">"Time (years)"</span>, ylab<span class="op">=</span><span class="st">"Cohort height (m)"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">h2</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">n</span>, <span class="op">]</span>, <span class="va">h2</span><span class="op">[</span><span class="op">-</span><span class="va">n</span>, <span class="op">]</span>, col<span class="op">=</span><span class="va">col2</span><span class="op">[</span><span class="op">-</span><span class="va">n</span>, <span class="op">]</span>, lend<span class="op">=</span><span class="st">"butt"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/segments.html">segments</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">h1</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="va">n</span>, <span class="op">]</span>, <span class="va">h1</span><span class="op">[</span><span class="op">-</span><span class="va">n</span>, <span class="op">]</span>, col<span class="op">=</span><span class="va">col1</span><span class="op">[</span><span class="op">-</span><span class="va">n</span>, <span class="op">]</span>, lend<span class="op">=</span><span class="st">"butt"</span><span class="op">)</span></code></pre></div>
<p><img src="figure/patch__unnamed-chunk-21-1.png"> Now we see that the high LMA species (blue) becomes dominant, excluding the low LMA species (red) from the canopy.</p>
<p>The changing intensity of competition can be shown as the total leaf area of each species:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">patches2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">result_2sp</span><span class="op">$</span><span class="va">time</span><span class="op">)</span>, <span class="va">scm_patch</span>, <span class="va">result_2sp</span><span class="op">)</span>
<span class="va">lai2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">patches2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="fu">compute_competition</span><span class="op">(</span><span class="fl">0.0</span><span class="op">)</span><span class="op">)</span>

<span class="va">lai2_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">patches2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">compute_competition</span><span class="op">(</span><span class="fl">0.0</span><span class="op">)</span><span class="op">)</span>
<span class="va">lai2_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">patches2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">compute_competition</span><span class="op">(</span><span class="fl">0.0</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Patch total LAI (dashed)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">lai2</span>, type<span class="op">=</span><span class="st">"l"</span>, las<span class="op">=</span><span class="fl">1</span>, lty<span class="op">=</span><span class="fl">2</span>,
     xlab<span class="op">=</span><span class="st">"Time (years)"</span>, ylab<span class="op">=</span><span class="st">"Leaf area index"</span><span class="op">)</span>

<span class="co"># Species 1 LAI (red)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">lai2_1</span>, col<span class="op">=</span><span class="va">cols</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>

<span class="co"># Species 2 LAI (blue)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">t2</span>, <span class="va">lai2_2</span>, col<span class="op">=</span><span class="va">cols</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="figure/patch__unnamed-chunk-22-1.png"></p>
<!-- TODO: Introduce meta populations:

To find the average value over the metapopulation we weight by patch abundance:


```r
metapopulation <- function(x){
  plant:::trapezium(t2, x*result_2sp$patch_density)
}

lai2_av <- metapopulation(lai2)
lai2_1_av <- metapopulation(lai2_1)
lai2_2_av <- metapopulation(lai2_2)

plot(t2, lai2, type="l", las=1, lty=2,
     xlab="Time (years)", ylab="Leaf area index")
lines(t2, lai2_1, col=cols[[1]])
lines(t2, lai2_2, col=cols[[2]])

axis(4, at=lai2_av,   tck=0.1, lty = 2, labels=NA)
axis(4, at=lai2_1_av, tck=0.1, col.ticks=cols[[1]], labels=NA)
axis(4, at=lai2_2_av, tck=0.1, col.ticks=cols[[2]], labels=NA)
axis(1, at=108, labels="Av")
```

![](figure/patch__unnamed-chunk-23-1.png)
-->
</div>
<div id="appendix---ggplot-example" class="section level1">
<h1 class="hasAnchor">
<a href="#appendix---ggplot-example" class="anchor"></a>Appendix - <code>ggplot</code> example</h1>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#' A standard plot for density weighted cohort trajectories</span>
<span class="co">#'</span>
<span class="co">#' Parameters:</span>
<span class="co">#'  - result: the output of `run_scm_collect`</span>
<span class="co">#'  - threshold: lower bound on density</span>
<span class="co">#' </span>
<span class="co">#' Requires:</span>
<span class="co">#'  - ggplot2</span>
<span class="co">#'  - dplyr</span>

<span class="va">patch</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">result</span>, <span class="va">threshold</span> <span class="op">=</span> <span class="fl">1e-3</span><span class="op">)</span> <span class="op">{</span>

  <span class="co"># Unpack state and density</span>
  <span class="va">t</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">time</span>
  <span class="va">h</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"height"</span>, , <span class="op">]</span>
  <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">species</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="st">"log_density"</span>, , <span class="op">]</span>
  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span>
  
  <span class="co"># Convert to long format</span>
  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>cohort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">)</span>,
                   time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">t</span>, times <span class="op">=</span> <span class="va">n</span><span class="op">)</span>,
                   height <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">h</span><span class="op">)</span>,
                   log_density <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">mutate</span><span class="op">(</span>density <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">log_density</span><span class="op">)</span><span class="op">)</span> 
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">density</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># Plot with densities</span>
  <span class="fu">ggplot</span><span class="op">(</span><span class="va">df</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">height</span>,
                 group <span class="op">=</span> <span class="va">cohort</span>, alpha <span class="op">=</span> <span class="va">density</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_line</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu">labs</span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time (years)"</span>,
         y <span class="op">=</span> <span class="st">"Height (m)"</span>,
         alpha <span class="op">=</span> <span class="st">"Density"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme_bw</span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Daniel Falster, Richard FitzJohn, Rafael Schouten, Andrew O'Reilly-Nugent.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
