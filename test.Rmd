

```{r}
devtools::load_all()

params <- scm_base_parameters("FF16")

control <- scm_base_control()
control$equilibrium_solver_name <- "hybrid"
control$equilibrium_eps <- 1e-5
control$save_RK45_cache <- TRUE

plant_log_console()
```

# Fitness landscape


```{r}
lma_attr <- 0.0825
traits <- trait_matrix(lma_attr, c("lma"))

p1 <- expand_parameters(traits, params)
p1_eq <- equilibrium_birth_rate(p1, control)

rr <- attr(p1_eq, "progress")
log(rr[5, "out"] / rr[5, "in"])

fitness_attr <- fitness_landscape(traits, p1_eq)

(fitness_attr)

p2 <- expand_parameters(traits, params, birth_rate_list = 17.31732)

results <- build_schedule(p2, ctrl = control)
scm <- run_scm(results, ctrl = control)
scm$net_reproduction_ratios

scm$run_mutant(p2)
scm$net_reproduction_ratios

results2 <- expand_parameters(traits, results, birth_rate_list = 0)

scm$run_mutant(results)
scm$net_reproduction_ratios

scm$run_mutant(results2)
scm$net_reproduction_ratios


results3 <- expand_parameters(traits, results, birth_rate_list = 0)


```
run_scm()


add_eq(lma_attr, params, ctrl = control)
patch_eq_attr$strategies[[1]]$birth_rate_y <- 17.30628

fitness_attr <- fitness_landscape(lma, patch_eq_attr)
plot(lma, fitness_attr, log="x", type="l", las=1,
     xlab="Leaf mass per unit leaf area", ylab="Fitness")
abline(h=0, col="grey")
points(lma_attr, 0, pch=19)
```

Zooming in in the vicinity of the result shows that this is
disruptive selection: fitness increases to both sides of the
resident!

```{r}
lma_detail <- trait_matrix(seq_log(lma_attr * 0.95, lma_attr * 1.05, 51), "lma")
fitness_detail <- fitness_landscape(lma_detail, patch_eq_attr, ctr = control)
plot(lma_detail, fitness_detail, log="x", type="l", las=1,
     xlab="Leaf mass per unit leaf area", ylab="Fitness")
abline(h=0, col="grey")
points(lma_attr, 0, pch=19)
```

# Invasion landscapes

Holding the first species at 0.0825 we can introduce additional
species (it's close enough to the optimum here, though in general
this point might move substantially as new species are introduced).

Consider the point of maximum fitness:

```{r}
lma_max <- lma[which.max(fitness_attr)]
lma_max

plot(lma, fitness_attr, log="x", type="l", las=1,
     xlab="Leaf mass per unit leaf area", ylab="Fitness")
abline(h=0, col="grey")
points(lma_attr, 0, pch=19)
abline(v=lma_max, col="red")
```

Introducing a new species the point of maximum fitness 
*draws the fitness landscape  down* around the second species, 
with a fitness gradient that points towards increased LMA.

```{r}
patch_eq_max <- add_eq(lma_max, patch_eq_attr)
fitness_max <- fitness_landscape(lma, patch_eq_max)

plot(lma, fitness_attr, log="x", type="l", las=1,
     xlab="Leaf mass per unit leaf area", ylab="Fitness", col="grey")
lines(lma, fitness_max)
abline(h=0, col="grey")
points(lma_attr, 0, pch=19)
points(lma_max, 0, pch=19, col="red")
lma_max_2 <- lma[which.max(fitness_max)]
abline(v=lma_max_2)
```

At the cost of extremely tedious copy/paste code, here is the
result of repeatedly taking the lma value with highest fitness and
moving the second species to this point, running to equilibrium,
and plotting.  For comparison the previous landscapes are retained
as dotted lines.

```{r}
patch_eq_max_2 <- add_eq(lma_max_2, patch_eq_attr)
fitness_max_2 <- fitness_landscape(lma, patch_eq_max_2)

plot(lma, fitness_attr, log="x", type="l", las=1,
     xlab="Leaf mass per unit leaf area", ylab="Fitness", col="grey")
lines(lma, fitness_max, lty=2)
lines(lma, fitness_max_2)
abline(h=0, col="grey")
points(lma_attr, 0, pch=19)
points(lma_max, 0)
points(lma_max_2, 0, pch=19, col="red")
lma_max_3 <- lma[which.max(fitness_max_2)]
abline(v=lma_max_3)

patch_eq_max_3 <- add_eq(lma_max_3, patch_eq_attr)
fitness_max_3 <- fitness_landscape(lma, patch_eq_max_3)

plot(lma, fitness_attr, log="x", type="l", las=1,
     xlab="Leaf mass per unit leaf area", ylab="Fitness", col="grey")
lines(lma, fitness_max, lty=2)
lines(lma, fitness_max_2, lty=2)
lines(lma, fitness_max_3)
abline(h=0, col="grey")
points(lma_attr, 0, pch=19)
points(lma_max, 0)
points(lma_max_2, 0)
points(lma_max_3, 0, pch=19, col="red")
lma_max_4 <- lma[which.max(fitness_max_3)]
abline(v=lma_max_4)

patch_eq_max_4 <- add_eq(lma_max_4, patch_eq_attr)
fitness_max_4 <- fitness_landscape(lma, patch_eq_max_4)

plot(lma, fitness_attr, log="x", type="l", las=1,
     xlab="Leaf mass per unit leaf area", ylab="Fitness", col="grey")
lines(lma, fitness_max, lty=2)
lines(lma, fitness_max_2, lty=2)
lines(lma, fitness_max_3, lty=2)
lines(lma, fitness_max_4)
abline(h=0, col="grey")
points(lma_attr, 0, pch=19)
points(lma_max, 0)
points(lma_max_2, 0)
points(lma_max_3, 0)
points(lma_max_4, 0, pch=19, col="red")

lma_max_5 <- lma[which.max(fitness_max_4)]
abline(v=lma_max_5)
```
